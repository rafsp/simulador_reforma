<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Reforma Tribut√°ria | PEERS</title>
    
    <!-- Tailwind CSS Compilado -->
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF e html2canvas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --peers-blue: #011334;
            --peers-blue-dark: #001026;
            --peers-lime: #E1FF00;
            --peers-white: #FFFFFF;
            --peers-light-gray: #F2F2F2;
            --peers-medium-gray: #E5E7EB;
            --peers-text-gray: #6b7280;
            --peers-dark-gray: #374151;
            --peers-success: #10b981;
            --peers-danger: #ef4444;
            --peers-warning: #f59e0b;
        }
        
        * {
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--peers-light-gray);
            line-height: 1.6;
            color: var(--peers-dark-gray);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .peers-card {
            background: var(--peers-white);
            border-radius: 1.5rem;
            box-shadow: 0 4px 20px rgba(1, 19, 52, 0.08);
            padding: 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .peers-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--peers-lime) 0%, var(--peers-blue) 100%);
            opacity: 0;
            transition: 0.3s;
        }
        
        .peers-card:hover::before {
            opacity: 1;
        }
        
        .peers-header {
            background: linear-gradient(135deg, var(--peers-blue) 0%, var(--peers-blue-dark) 100%);
            color: var(--peers-white);
            text-align: center;
            padding: 3rem 1.5rem;
            border-radius: 1.5rem;
            margin-bottom: 2.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .peers-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(225, 255, 0, 0.1) 0%, transparent 70%);
        }
        
        .peers-btn {
            background: var(--peers-lime);
            color: var(--peers-blue);
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(225, 255, 0, 0.3);
            display: inline-block;
        }
        
        .peers-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(225, 255, 0, 0.4);
        }
        
        .peers-btn-secondary {
            background: var(--peers-blue);
            color: var(--peers-white);
            box-shadow: 0 4px 15px rgba(1, 19, 52, 0.3);
        }
        
        .peers-input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .peers-input {
            width: 100%;
            padding: 1rem 1.25rem 1rem 3rem;
            border: 2px solid var(--peers-medium-gray);
            border-radius: 0.75rem;
            font-size: 1rem;
            background: var(--peers-white);
            transition: 0.3s;
        }
        
        .peers-input:focus {
            outline: none;
            border-color: var(--peers-lime);
            box-shadow: 0 0 0 4px rgba(225, 255, 0, 0.1);
        }
        
        .peers-input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--peers-text-gray);
            pointer-events: none;
        }
        
        .peers-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--peers-blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .profile-option {
            border: 3px solid var(--peers-medium-gray);
            transition: 0.3s;
            cursor: pointer;
            background: var(--peers-white);
            border-radius: 1rem;
            padding: 2rem;
        }
        
        .profile-option:hover {
            border-color: var(--peers-lime);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(1, 19, 52, 0.1);
        }
        
        .profile-option.selected {
            border-color: var(--peers-blue);
            background: linear-gradient(135deg, rgba(1, 19, 52, 0.02) 0%, rgba(225, 255, 0, 0.05) 100%);
        }
        
        .results-section {
            background: linear-gradient(135deg, var(--peers-blue) 0%, var(--peers-blue-dark) 100%);
            color: var(--peers-white);
            border-radius: 1.5rem;
            padding: 3rem;
            margin-top: 2rem;
        }
        
        .scenario-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 1.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(229, 231, 235, 0.1);
        }
        
        .cost-item:last-child {
            border-bottom: none;
        }
        
        .cost-item.total {
            margin-top: 1rem;
            padding-top: 1.25rem;
            border-top: 2px solid var(--peers-lime);
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .value-highlight {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--peers-lime);
        }
        
        .positive {
            color: var(--peers-success);
        }
        
        .negative {
            color: var(--peers-danger);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--peers-medium-gray);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--peers-lime) 0%, var(--peers-success) 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-fill.warning {
            background: linear-gradient(90deg, var(--peers-warning) 0%, var(--peers-danger) 100%);
        }
        
        .tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: help;
        }
        
        .tooltip-icon {
            width: 18px;
            height: 18px;
            background: var(--peers-medium-gray);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--peers-dark-gray);
            margin-left: 0.25rem;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: var(--peers-blue);
            color: var(--peers-white);
            text-align: left;
            border-radius: 0.75rem;
            padding: 1rem;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: 0.3s;
            font-size: 0.875rem;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(-5px);
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
            .peers-card {
                padding: 1.5rem;
            }
            .results-section {
                padding: 2rem;
            }
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="antialiased">
    <div class="max-w-6xl mx-auto p-5">
        <!-- Header -->
        <div class="peers-header">
            <img src="https://d3fh32tca5cd7q.cloudfront.net/wp-content/uploads/2025/03/logo.svg" 
                 alt="PEERS" 
                 style="height: 45px; width: auto; display: block; margin: 0 auto 1.5rem;">
            <h1 class="text-3xl md:text-4xl font-bold mb-3">Simulador de Reforma Tribut√°ria</h1>
            <p class="text-base md:text-lg opacity-90 max-w-2xl mx-auto">
                Descubra como a nova legisla√ß√£o tribut√°ria impactar√° seus custos de transporte e prepare-se para o futuro
            </p>
        </div>

        <!-- Progress Indicator -->
        <div id="progress-indicator" class="peers-card mb-4 hidden">
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium" style="color: var(--peers-blue);">Progresso da simula√ß√£o</span>
                <span id="progress-text" class="text-sm font-medium" style="color: var(--peers-text-gray);">0%</span>
            </div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Lead Form -->
        <div id="lead-form" class="peers-card animate-fade-in hidden">
            <div class="text-center mb-8">
                <h2 class="text-2xl md:text-3xl font-semibold mb-3" style="color: var(--peers-blue);">Complete seu cadastro</h2>
                <p class="text-base" style="color: var(--peers-text-gray);">Para receber o relat√≥rio completo da simula√ß√£o</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                <div class="peers-input-group">
                    <label class="peers-label">Nome completo <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <span class="peers-input-icon">üë§</span>
                        <input type="text" id="lead-nome" class="peers-input" placeholder="Jo√£o Silva" required>
                    </div>
                </div>
                <div class="peers-input-group">
                    <label class="peers-label">Empresa <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <span class="peers-input-icon">üè¢</span>
                        <input type="text" id="lead-empresa" class="peers-input" placeholder="Empresa ABC" required>
                    </div>
                </div>
                <div class="peers-input-group">
                    <label class="peers-label">Cargo</label>
                    <div class="relative">
                        <span class="peers-input-icon">üíº</span>
                        <input type="text" id="lead-cargo" class="peers-input" placeholder="Gerente de Opera√ß√µes">
                    </div>
                </div>
                <div class="peers-input-group">
                    <label class="peers-label">E-mail corporativo <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <span class="peers-input-icon">‚úâÔ∏è</span>
                        <input type="email" id="lead-email" class="peers-input" placeholder="joao@empresa.com" required>
                    </div>
                </div>
            </div>
            <div class="text-center mt-8">
                <button class="peers-btn px-12 py-4 text-lg" id="btn-generate-pdf">
                    Continuar ‚Üí
                </button>
                <p class="text-xs mt-4" style="color: var(--peers-text-gray);">Seus dados est√£o seguros e n√£o ser√£o compartilhados</p>
            </div>
        </div>

        <!-- Profile Selector -->
        <div id="profile-selector" class="peers-card">
            <div class="text-center mb-8">
                <h2 class="text-2xl md:text-3xl font-semibold mb-3" style="color: var(--peers-blue);">Qual √© o seu perfil?</h2>
                <p class="text-base" style="color: var(--peers-text-gray);">Escolha a op√ß√£o que melhor descreve sua opera√ß√£o</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                <div class="profile-option text-center" id="btn-tomador">
                    <div class="text-5xl mb-3">üì¶</div>
                    <h3 class="font-semibold text-xl mb-2" style="color: var(--peers-blue);">Contratante</h3>
                    <p class="text-sm" style="color: var(--peers-text-gray);">Sua empresa contrata transportadoras para movimentar suas cargas</p>
                </div>
                <div class="profile-option text-center" id="btn-prestador">
                    <div class="text-5xl mb-3">üöö</div>
                    <h3 class="font-semibold text-xl mb-2" style="color: var(--peers-blue);">Transportadora</h3>
                    <p class="text-sm" style="color: var(--peers-text-gray);">Sua empresa presta servi√ßos de transporte rodovi√°rio de cargas</p>
                </div>
            </div>
        </div>

        <!-- Prestador Form -->
        <div id="prestador-form" class="hidden">
            <div class="peers-card animate-fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold" style="color: var(--peers-blue);">Informa√ß√µes Financeiras</h2>
                    <button id="btn-example" class="text-sm font-medium peers-btn-secondary px-4 py-2">
                        Ver exemplo
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="peers-input-group">
                        <label class="peers-label">
                            Receita Bruta Anual
                            <span class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">Valor total da receita com fretes no per√≠odo de 12 meses</span>
                            </span>
                        </label>
                        <div class="relative">
                            <span class="peers-input-icon">R$</span>
                            <input type="text" id="receita-bruta" class="peers-input" placeholder="0,00">
                        </div>
                    </div>
                    <div class="peers-input-group">
                        <label class="peers-label">
                            Custos Operacionais Totais
                            <span class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">Soma de todos os custos operacionais do per√≠odo</span>
                            </span>
                        </label>
                        <div class="relative">
                            <span class="peers-input-icon">R$</span>
                            <input type="text" id="custos-totais" class="peers-input" placeholder="0,00">
                        </div>
                    </div>
                </div>
            </div>

            <div class="peers-card animate-fade-in" style="animation-delay: 0.1s;">
                <h3 class="text-xl font-semibold mb-6" style="color: var(--peers-blue);">
                    Composi√ß√£o dos Custos Operacionais (%)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label class="peers-label">‚õΩ Diesel</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-diesel-range" min="0" max="100" value="35" step="0.1" class="flex-1">
                            <input type="number" id="custo-diesel" class="w-20 p-2 border rounded text-center" value="35" min="0" max="100" step="0.1">
                            <span>%</span>
                        </div>
                    </div>
                    <div>
                        <label class="peers-label">üõ£Ô∏è Ped√°gio</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-pedagio-range" min="0" max="100" value="6" step="0.1" class="flex-1">
                            <input type="number" id="custo-pedagio" class="w-20 p-2 border rounded text-center" value="6" min="0" max="100" step="0.1">
                            <span>%</span>
                        </div>
                    </div>
                    <div>
                        <label class="peers-label">üîß Manuten√ß√£o</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-manutencao-range" min="0" max="100" value="6" step="0.1" class="flex-1">
                            <input type="number" id="custo-manutencao" class="w-20 p-2 border rounded text-center" value="6" min="0" max="100" step="0.1">
                            <span>%</span>
                        </div>
                    </div>
                    <div>
                        <label class="peers-label">üìç Rastreamento/Pneus</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-rastreamento-range" min="0" max="100" value="6" step="0.1" class="flex-1">
                            <input type="number" id="custo-rastreamento" class="w-20 p-2 border rounded text-center" value="6" min="0" max="100" step="0.1">
                            <span>%</span>
                        </div>
                    </div>
                    <div>
                        <label class="peers-label">üë• M√£o de obra</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-mao-obra-range" min="0" max="100" value="25" step="0.1" class="flex-1">
                            <input type="number" id="custo-mao-obra" class="w-20 p-2 border rounded text-center" value="25" min="0" max="100" step="0.1">
                            <span>%</span>
                        </div>
                    </div>
                    <div>
                        <label class="peers-label">üìä Deprecia√ß√£o/Seguro</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-depreciacao-range" min="0" max="100" value="6" step="0.1" class="flex-1">
                            <input type="number" id="custo-depreciacao" class="w-20 p-2 border rounded text-center" value="6" min="0" max="100" step="0.1">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="lg:col-span-3">
                        <label class="peers-label">üìã Outros (admin e fixos)</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-outros-range" min="0" max="100" value="16" step="0.1" class="flex-1 max-w-md">
                            <input type="number" id="custo-outros" class="w-20 p-2 border rounded text-center" value="16" min="0" max="100" step="0.1">
                            <span>%</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8 p-4 rounded-xl" style="background: var(--peers-light-gray);">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium" style="color: var(--peers-blue);">Total dos custos especificados:</span>
                        <span id="total-custos-percent" class="text-2xl font-bold" style="color: var(--peers-blue);">100%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="cost-progress-fill" class="progress-fill" style="width: 100%"></div>
                    </div>
                    <p id="cost-warning" class="text-sm mt-2 hidden" style="color: var(--peers-danger);">
                        ‚ö†Ô∏è A soma deve ser exatamente 100%. Ajuste os valores.
                    </p>
                </div>
            </div>

            <div class="text-center mt-8">
                <button class="peers-btn px-12 py-4 text-lg" id="btn-calcular-prestador">
                    Calcular Impacto ‚Üí
                </button>
            </div>
        </div>

        <!-- Tomador Form -->
        <div id="tomador-form" class="hidden">
            <div class="peers-card animate-fade-in">
                <div class="text-center mb-8">
                    <h2 class="text-2xl md:text-3xl font-semibold mb-3" style="color: var(--peers-blue);">
                        Quanto voc√™ gasta com frete?
                    </h2>
                    <p class="text-base" style="color: var(--peers-text-gray);">
                        Informe o valor total anual gasto com contrata√ß√£o de transportadoras
                    </p>
                </div>
                <div class="max-w-md mx-auto">
                    <div class="peers-input-group">
                        <label class="peers-label text-lg">
                            Custo Total com Frete (√∫ltimos 12 meses)
                            <span class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">Valor total pago em fretes no per√≠odo de 12 meses</span>
                            </span>
                        </label>
                        <div class="relative">
                            <span class="peers-input-icon text-xl">R$</span>
                            <input type="text" id="custo-frete" class="peers-input text-xl py-4 pl-12" placeholder="0,00">
                        </div>
                        <p class="text-sm mt-2" style="color: var(--peers-text-gray);">Exemplo: R$ 10.000.000,00</p>
                    </div>
                </div>
                <div class="text-center mt-8">
                    <button class="peers-btn px-12 py-4 text-lg" id="btn-calcular-tomador">
                        Calcular Economia ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultados" class="hidden">
            <div class="results-section animate-fade-in">
                <div class="text-center mb-8">
                    <h2 class="text-3xl md:text-4xl font-bold mb-3">An√°lise do Impacto Tribut√°rio</h2>
                    <p class="text-lg opacity-90">Comparativo entre o cen√°rio atual e a nova legisla√ß√£o</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="scenario-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">üìã Cen√°rio Atual</h3>
                            <span class="text-sm opacity-75">Pr√©-Reforma</span>
                        </div>
                        <div id="pre-reforma-content"></div>
                    </div>
                    <div class="scenario-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">üöÄ Cen√°rio Futuro</h3>
                            <span class="text-sm opacity-75">P√≥s-Reforma</span>
                        </div>
                        <div id="pos-reforma-content"></div>
                    </div>
                </div>

                <div class="text-center p-8 rounded-xl" style="background: rgba(225, 255, 0, 0.15);">
                    <h3 class="text-2xl font-semibold mb-4">üí° Impacto Final</h3>
                    <div id="impacto-final" class="value-highlight mb-4"></div>
                    <div id="observacoes" class="text-sm opacity-90"></div>
                </div>

                <!-- Charts Section -->
                <div id="charts-section" class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-center">üìä Visualiza√ß√£o dos Dados</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="chart-card">
                            <h4 class="text-lg font-medium mb-3">Comparativo de Cen√°rios</h4>
                            <div class="chart-container">
                                <canvas id="scenarioComparisonChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card" id="costBreakdownContainer">
                            <h4 class="text-lg font-medium mb-3">Composi√ß√£o dos Custos (%)</h4>
                            <div class="chart-container">
                                <canvas id="costBreakdownChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card" id="creditsEvolutionContainer">
                            <h4 class="text-lg font-medium mb-3" id="creditsEvolutionTitle">Evolu√ß√£o dos Cr√©ditos</h4>
                            <div class="chart-container">
                                <canvas id="creditsEvolutionChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h4 class="text-lg font-medium mb-3">An√°lise de Impacto</h4>
                            <div class="chart-container">
                                <canvas id="impactAnalysisChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 p-6 rounded-xl" style="background: rgba(255, 255, 255, 0.1);">
                    <h4 class="text-lg font-semibold mb-3">üìä Resumo Executivo</h4>
                    <div id="resumo-executivo" class="text-sm opacity-90 space-y-2"></div>
                </div>

                <div class="text-center mt-8 space-x-4 no-print">
                    <button class="peers-btn-secondary px-8 py-3" id="btn-nova-simulacao">
                        üîÑ Nova Simula√ß√£o
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== INTEGRA√á√ÉO COM GOOGLE SHEETS ===== -->
    <script>
        // URL do Google Apps Script configurada
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzk3FJpmHMFsysq2svePRDmc1qjEJdrqpazsn1hj3hYNlEDH_20LJbMBkFp0YDCP_FjTg/exec';

        // Sistema de gerenciamento de leads
        class LeadsManager {
            constructor() {
                this.isProcessing = false;
                this.retryDelay = 2000; // 2 segundos entre tentativas
            }

            // Salvar lead (tenta enviar primeiro, se falhar salva localmente)
            async salvarLead(nome, empresa, cargo, email) {
                const lead = {
                    timestamp: new Date().toISOString(),
                    nome: nome,
                    empresa: empresa,
                    cargo: cargo,
                    email: email,
                    enviado: false
                };

                try {
                    // Tentar enviar diretamente
                    await this.enviarParaGoogleSheets(lead);
                    lead.enviado = true;
                    console.log('‚úÖ Lead enviado diretamente para Google Sheets');
                    
                    // Salvar no hist√≥rico de enviados
                    this.salvarNoHistorico(lead);
                    
                } catch (error) {
                    // Se falhar, adicionar √† fila de pendentes
                    console.log('‚è≥ Lead salvo na fila para envio posterior');
                    this.adicionarAFilaPendente(lead);
                }
            }

            // Enviar para Google Sheets
            async enviarParaGoogleSheets(lead) {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nome: lead.nome || '',
                        empresa: lead.empresa || '',
                        cargo: lead.cargo || '',
                        email: lead.email || ''
                    })
                });
                // Como √© no-cors, assumimos sucesso se n√£o houver erro
                return true;
            }

            // Adicionar √† fila de pendentes
            adicionarAFilaPendente(lead) {
                const pendentes = this.getLeadsPendentes();
                pendentes.push(lead);
                localStorage.setItem('leads_pendentes', JSON.stringify(pendentes));
            }

            // Obter leads pendentes
            getLeadsPendentes() {
                return JSON.parse(localStorage.getItem('leads_pendentes') || '[]');
            }

            // Salvar no hist√≥rico
            salvarNoHistorico(lead) {
                const historico = JSON.parse(localStorage.getItem('leads_historico') || '[]');
                historico.push(lead);
                localStorage.setItem('leads_historico', JSON.stringify(historico));
            }

            // Processar fila de pendentes
            async processarFilaPendentes() {
                if (this.isProcessing) return;
                
                const pendentes = this.getLeadsPendentes();
                if (pendentes.length === 0) return;

                this.isProcessing = true;
                console.log(`üì§ Processando ${pendentes.length} leads pendentes...`);

                const naoEnviados = [];
                let sucessos = 0;

                for (const lead of pendentes) {
                    try {
                        await this.enviarParaGoogleSheets(lead);
                        lead.enviado = true;
                        this.salvarNoHistorico(lead);
                        sucessos++;
                        console.log(`‚úÖ Lead ${sucessos}/${pendentes.length} enviado`);
                        
                        // Pequena pausa entre envios
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao enviar lead:', error);
                        naoEnviados.push(lead);
                    }
                }

                // Atualizar lista de pendentes com os que falharam
                localStorage.setItem('leads_pendentes', JSON.stringify(naoEnviados));

                if (sucessos > 0) {
                    console.log(`üéâ ${sucessos} leads enviados com sucesso!`);
                }

                if (naoEnviados.length > 0) {
                    console.log(`‚è≥ ${naoEnviados.length} leads ainda pendentes`);
                }

                this.isProcessing = false;
            }

            // Migrar leads antigos do formato anterior
            async migrarLeadsAntigos() {
                const leadsBackup = JSON.parse(localStorage.getItem('leads_backup') || '[]');
                
                if (leadsBackup.length > 0) {
                    console.log(`üîÑ Migrando ${leadsBackup.length} leads do formato antigo...`);
                    
                    for (const lead of leadsBackup) {
                        lead.enviado = false;
                        this.adicionarAFilaPendente(lead);
                    }
                    
                    // Limpar o formato antigo
                    localStorage.removeItem('leads_backup');
                    
                    // Processar a fila
                    await this.processarFilaPendentes();
                }
            }

            // Obter estat√≠sticas
            getEstatisticas() {
                const pendentes = this.getLeadsPendentes();
                const historico = JSON.parse(localStorage.getItem('leads_historico') || '[]');
                
                return {
                    pendentes: pendentes.length,
                    enviados: historico.filter(l => l.enviado).length,
                    total: pendentes.length + historico.length
                };
            }

            // Limpar dados (√∫til para testes)
            limparTudo() {
                if (confirm('‚ö†Ô∏è Isso remover√° TODOS os leads salvos localmente. Continuar?')) {
                    localStorage.removeItem('leads_pendentes');
                    localStorage.removeItem('leads_historico');
                    localStorage.removeItem('leads_backup');
                    console.log('üóëÔ∏è Todos os dados locais foram limpos');
                }
            }
        }

        // Instanciar o gerenciador de leads
        const leadsManager = new LeadsManager();

        // Fun√ß√£o para compatibilidade com c√≥digo existente
        function salvarSilenciosamente(nome, empresa, cargo, email) {
            leadsManager.salvarLead(nome, empresa, cargo, email);
        }

        // Processar fila ao carregar a p√°gina
        window.addEventListener('load', async () => {
            // Aguardar 3 segundos para n√£o interferir no carregamento
            setTimeout(async () => {
                // Migrar leads antigos se existirem
                await leadsManager.migrarLeadsAntigos();
                
                // Processar fila de pendentes
                await leadsManager.processarFilaPendentes();
                
                // Mostrar estat√≠sticas no console
                const stats = leadsManager.getEstatisticas();
                if (stats.total > 0) {
                    console.log('üìä Estat√≠sticas de Leads:', stats);
                }
            }, 3000);
        });

        // Processar fila quando voltar online
        window.addEventListener('online', () => {
            console.log('üåê Conex√£o restaurada! Processando leads pendentes...');
            setTimeout(() => {
                leadsManager.processarFilaPendentes();
            }, 2000);
        });

        // Processar fila a cada 5 minutos (caso haja pendentes)
        setInterval(() => {
            const pendentes = leadsManager.getLeadsPendentes();
            if (pendentes.length > 0) {
                console.log('‚è∞ Verifica√ß√£o autom√°tica de leads pendentes...');
                leadsManager.processarFilaPendentes();
            }
        }, 5 * 60 * 1000); // 5 minutos

        // Fun√ß√µes √∫teis para o console (debugging)
        window.leadsDebug = {
            verPendentes: () => {
                const pendentes = leadsManager.getLeadsPendentes();
                console.table(pendentes);
                return pendentes;
            },
            verHistorico: () => {
                const historico = JSON.parse(localStorage.getItem('leads_historico') || '[]');
                console.table(historico);
                return historico;
            },
            estatisticas: () => {
                const stats = leadsManager.getEstatisticas();
                console.log('üìä Estat√≠sticas:', stats);
                return stats;
            },
            forcarEnvio: () => {
                console.log('üöÄ For√ßando envio de pendentes...');
                leadsManager.processarFilaPendentes();
            },
            limparTudo: () => {
                leadsManager.limparTudo();
            }
        };

        console.log('üí° Sistema de Leads carregado! Use leadsDebug no console para debug.');
    </script>
    <!-- ===== FIM DA INTEGRA√á√ÉO ===== -->

    <script>
        // Desabilitar warnings do console (remove o aviso do Tailwind)
        console.warn = () => {};
        
        // Estado Global
        let selectedProfile = '';
        let leadData = {};
        let simulationData = {};
        let charts = {};

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Simulador de Reforma Tribut√°ria - PEERS iniciado com sucesso!');
            
            // Configurar Chart.js se dispon√≠vel
            if (typeof Chart !== 'undefined') {
                Chart.defaults.font.family = "'Poppins', sans-serif";
                Chart.defaults.plugins.legend.labels.usePointStyle = true;
                Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(1, 19, 52, 0.9)';
                Chart.defaults.plugins.tooltip.padding = 12;
                Chart.defaults.plugins.tooltip.cornerRadius = 8;
            }
            
            // Event Listeners
            setupEventListeners();
            
            // Configurar m√°scaras de input
            setupInputMasks();
        });

        // Configurar Event Listeners
        function setupEventListeners() {
            // Bot√µes de perfil
            document.getElementById('btn-tomador')?.addEventListener('click', () => selectProfile('tomador'));
            document.getElementById('btn-prestador')?.addEventListener('click', () => selectProfile('prestador'));
            
            // Bot√£o de exemplo
            document.getElementById('btn-example')?.addEventListener('click', () => showExample('prestador'));
            
            // Bot√µes de c√°lculo
            document.getElementById('btn-calcular-prestador')?.addEventListener('click', calcularPrestador);
            document.getElementById('btn-calcular-tomador')?.addEventListener('click', calcularTomador);
            
            // Bot√£o do lead form
            document.getElementById('btn-generate-pdf')?.addEventListener('click', validateLeadAndProceed);
            
            // Bot√£o nova simula√ß√£o
            document.getElementById('btn-nova-simulacao')?.addEventListener('click', () => location.reload());
            
            // Sliders de custo
            const custos = ['diesel', 'pedagio', 'manutencao', 'rastreamento', 'mao-obra', 'depreciacao', 'outros'];
            custos.forEach(tipo => {
                const range = document.getElementById(`custo-${tipo}-range`);
                const input = document.getElementById(`custo-${tipo}`);
                
                if (range) {
                    range.addEventListener('input', () => updateCostFromRange(tipo));
                }
                if (input) {
                    input.addEventListener('input', () => updateRangeFromInput(tipo));
                }
            });
        }

        // Configurar m√°scaras de input
        function setupInputMasks() {
            const moneyInputs = ['receita-bruta', 'custos-totais', 'custo-frete'];
            
            moneyInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function(e) {
                        formatInputCurrency(e.target);
                    });
                    input.addEventListener('focus', function(e) {
                        e.target.select();
                    });
                }
            });
        }

        // Fun√ß√µes Utilit√°rias
        function formatInputCurrency(input) {
            let raw = (input.value || '').replace(/\D/g, '');
            if (!raw) {
                input.value = '';
                return;
            }
            let num = Number(raw) / 100;
            if (isNaN(num)) {
                input.value = '';
                return;
            }
            let v = num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            input.value = v;
        }

        function parseCurrency(value) {
            if (!value) return 0;
            const n = parseFloat(String(value).replace(/\./g, '').replace(',', '.'));
            return isNaN(n) ? 0 : n;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatPercentage(value) {
            return (value * 100).toFixed(2) + '%';
        }

        // Profile Selection
        function selectProfile(profile) {
            selectedProfile = profile;
            document.getElementById('profile-selector').classList.add('hidden');
            updateProgress(1);
            
            if (profile === 'prestador') {
                document.getElementById('prestador-form').classList.remove('hidden');
            } else {
                document.getElementById('tomador-form').classList.remove('hidden');
            }
            
            document.getElementById('progress-indicator').classList.remove('hidden');
        }

        // Progress Update
        function updateProgress(step) {
            const progress = (step / 3) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = Math.round(progress) + '%';
        }

        // Cost Sliders
        function updateCostFromRange(tipo) {
            const range = document.getElementById(`custo-${tipo}-range`);
            const input = document.getElementById(`custo-${tipo}`);
            input.value = range.value;
            updateTotalCosts();
        }

        function updateRangeFromInput(tipo) {
            const range = document.getElementById(`custo-${tipo}-range`);
            const input = document.getElementById(`custo-${tipo}`);
            range.value = input.value;
            updateTotalCosts();
        }

        function updateTotalCosts() {
            const custos = ['diesel', 'pedagio', 'manutencao', 'rastreamento', 'mao-obra', 'depreciacao', 'outros'];
            let total = 0;
            
            custos.forEach(tipo => {
                const value = parseFloat(document.getElementById(`custo-${tipo}`).value) || 0;
                total += value;
            });
            
            document.getElementById('total-custos-percent').textContent = total.toFixed(1) + '%';
            
            const bar = document.getElementById('cost-progress-fill');
            bar.style.width = Math.min(total, 100) + '%';
            
            if (Math.abs(total - 100) > 0.1) {
                bar.classList.add('warning');
                document.getElementById('cost-warning').classList.remove('hidden');
            } else {
                bar.classList.remove('warning');
                document.getElementById('cost-warning').classList.add('hidden');
            }
            
            return total;
        }

        // Exemplo
        function showExample(type) {
            if (type === 'prestador') {
                document.getElementById('receita-bruta').value = '100.000.000,00';
                document.getElementById('custos-totais').value = '75.000.000,00';
            }
        }

        // Lead Form - MODIFICADA COM INTEGRA√á√ÉO GOOGLE SHEETS
        function showLeadForm() {
            document.getElementById('lead-form').classList.remove('hidden');
            document.getElementById('lead-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function validateLeadAndProceed() {
            const nome = document.getElementById('lead-nome').value.trim();
            const empresa = document.getElementById('lead-empresa').value.trim();
            const email = document.getElementById('lead-email').value.trim();
            const cargo = document.getElementById('lead-cargo').value.trim();
            
            if (!nome || !empresa || !email) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }
            
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert('Por favor, insira um e-mail v√°lido.');
                return;
            }
            
            // NOVA LINHA: Salvar silenciosamente no Google Sheets
            salvarSilenciosamente(nome, empresa, cargo, email);
            
            leadData = { nome, empresa, cargo, email };
            
            // Esconder lead form
            document.getElementById('lead-form').classList.add('hidden');
            
            // Processar c√°lculos ap√≥s capturar lead
            processarCalculosAposLead();
        }

        // C√°lculos com Lead Gate
        function calcularPrestador() {
            if (Math.abs(updateTotalCosts() - 100) > 0.1) {
                alert('Por favor, ajuste os percentuais para totalizar 100%');
                return;
            }
            
            const receitaBruta = parseCurrency(document.getElementById('receita-bruta').value);
            const custosTotais = parseCurrency(document.getElementById('custos-totais').value);
            
            if (!receitaBruta || !custosTotais) {
                alert('Por favor, preencha todos os campos financeiros');
                return;
            }
            
            // Salvar dados temporariamente
            window.tempSimulationData = {
                tipo: 'prestador',
                receitaBruta,
                custosTotais,
                custoDiesel: parseFloat(document.getElementById('custo-diesel').value) || 0,
                custoPedagio: parseFloat(document.getElementById('custo-pedagio').value) || 0,
                custoManutencao: parseFloat(document.getElementById('custo-manutencao').value) || 0,
                custoRastreamento: parseFloat(document.getElementById('custo-rastreamento').value) || 0,
                custoMaoObra: parseFloat(document.getElementById('custo-mao-obra').value) || 0,
                custoDepreciacao: parseFloat(document.getElementById('custo-depreciacao').value) || 0,
                custoOutros: parseFloat(document.getElementById('custo-outros').value) || 0
            };
            
            // Mostrar lead form
            showLeadForm();
        }
        
        function calcularTomador() {
            const custoFrete = parseCurrency(document.getElementById('custo-frete').value);
            
            if (!custoFrete) {
                alert('Por favor, informe o custo total com frete');
                return;
            }
            
            // Salvar dados temporariamente
            window.tempSimulationData = {
                tipo: 'tomador',
                custoFrete
            };
            
            // Mostrar lead form
            showLeadForm();
        }
        
        // Processar c√°lculos ap√≥s lead
        function processarCalculosAposLead() {
            const data = window.tempSimulationData;
            
            if (data.tipo === 'prestador') {
                // Continuar c√°lculos do prestador
                const vDiesel = data.custosTotais * (data.custoDiesel / 100);
                const vPedagio = data.custosTotais * (data.custoPedagio / 100);
                const totalInsumosCreditaveis = vDiesel + vPedagio;

                // Pr√©-reforma
                const icmsPre = data.receitaBruta * 0.12;
                // CORRE√á√ÉO IMPORTANTE: PIS/COFINS calculado sobre CUSTOS, n√£o sobre receita!
                const pisCofinsPre = data.custosTotais * 0.0925;
                
                // CORRE√á√ÉO: Cr√©ditos apenas sobre insumos credit√°veis
                const creditoIcmsDiesel = vDiesel * 0.171; // ICMS s√≥ sobre diesel
                const creditoPisCofins = totalInsumosCreditaveis * 0.0925; // PIS/COFINS sobre diesel + ped√°gio
                const totalCreditosPre = creditoIcmsDiesel + creditoPisCofins;
                
                const receitaLiquidaPre = data.receitaBruta - icmsPre - pisCofinsPre;
                const custoEfetivoPre = data.custosTotais - totalCreditosPre;
                const lucroOperacionalPre = receitaLiquidaPre - data.custosTotais + totalCreditosPre;
                const margemPre = data.receitaBruta > 0 ? (lucroOperacionalPre / data.receitaBruta) : 0;

                // P√≥s-reforma
                const ibsPos = data.receitaBruta * 0.177;
                // CORRE√á√ÉO: CBS tamb√©m calculado sobre CUSTOS, n√£o sobre receita!
                const cbsPos = data.custosTotais * 0.088;
                
                // Cr√©ditos sobre insumos credit√°veis (diesel + ped√°gio)
                const creditoIbs = totalInsumosCreditaveis * 0.177;
                const creditoCbs = totalInsumosCreditaveis * 0.088;
                const totalCreditosPos = creditoIbs + creditoCbs;
                
                const receitaLiquidaPos = data.receitaBruta - ibsPos - cbsPos;
                const custoEfetivoPos = data.custosTotais - totalCreditosPos;
                const lucroOperacionalPos = receitaLiquidaPos - data.custosTotais + totalCreditosPos;
                const margemPos = data.receitaBruta > 0 ? (lucroOperacionalPos / data.receitaBruta) : 0;

                const diferencaLucro = lucroOperacionalPos - lucroOperacionalPre;
                const diferencaPercentual = lucroOperacionalPre !== 0 ? (diferencaLucro / lucroOperacionalPre) * 100 : 0;
                const reajusteNecessario = diferencaLucro < 0 ? Math.abs((diferencaLucro / data.receitaBruta) * 100) : 0;

                simulationData = {
                    tipo: 'prestador',
                    receitaBruta: data.receitaBruta,
                    custosTotais: data.custosTotais,
                    custoDiesel: data.custoDiesel / 100,
                    custoPedagio: data.custoPedagio / 100,
                    custoManutencao: data.custoManutencao / 100,
                    custoRastreamento: data.custoRastreamento / 100,
                    custoMaoObra: data.custoMaoObra / 100,
                    custoDepreciacao: data.custoDepreciacao / 100,
                    custoOutros: data.custoOutros / 100,
                    vDiesel, 
                    vPedagio,
                    totalInsumosCreditaveis,
                    icmsPre, 
                    pisCofinsPre, 
                    creditoIcmsDiesel, 
                    creditoPisCofins, 
                    totalCreditosPre, 
                    custoEfetivoPre,
                    receitaLiquidaPre,
                    ibsPos, 
                    cbsPos, 
                    creditoIbs, 
                    creditoCbs, 
                    totalCreditosPos, 
                    custoEfetivoPos,
                    receitaLiquidaPos,
                    lucroOperacionalPre, 
                    lucroOperacionalPos, 
                    margemPre, 
                    margemPos,
                    diferencaLucro, 
                    diferencaPercentual, 
                    reajusteNecessario
                };
                
            } else {
                // C√°lculos do tomador
                const custoFrete = data.custoFrete;
                
                const creditoIcmsPre = custoFrete * 0.024;
                const creditoPisCofinsPre = custoFrete * 0.0925;
                const totalCreditosPre = creditoIcmsPre + creditoPisCofinsPre;
                const custoEfetivoPre = custoFrete - totalCreditosPre;

                const creditoIbsPos = custoFrete * 0.177;
                const creditoCbsPos = custoFrete * 0.088;
                const totalCreditosPos = creditoIbsPos + creditoCbsPos;
                const custoEfetivoPos = custoFrete - totalCreditosPos;

                const reducaoCusto = custoEfetivoPre - custoEfetivoPos;
                const economiaPercentual = (reducaoCusto / custoEfetivoPre) * 100;

                simulationData = {
                    tipo: 'tomador',
                    custoFrete,
                    creditoIcmsPre, creditoPisCofinsPre, totalCreditosPre, custoEfetivoPre,
                    creditoIbsPos, creditoCbsPos, totalCreditosPos, custoEfetivoPos,
                    reducaoCusto, economiaPercentual
                };
            }
            
            // Limpar dados tempor√°rios
            delete window.tempSimulationData;
            
            // Mostrar resultados
            showResults();
        }

        // Exibir Resultados
        function showResults() {
            updateProgress(3);
            document.getElementById('prestador-form').classList.add('hidden');
            document.getElementById('tomador-form').classList.add('hidden');
            document.getElementById('resultados').classList.remove('hidden');

            const isPrestador = simulationData.tipo === 'prestador';
            document.getElementById('costBreakdownContainer').style.display = isPrestador ? '' : 'none';

            if (isPrestador) {
                displayPrestadorResults();
            } else {
                displayTomadorResults();
            }

            createCharts();
        }

        function displayPrestadorResults() {
            document.getElementById('pre-reforma-content').innerHTML = `
                <div class="cost-item">
                    <span>Receita Bruta:</span>
                    <span>${formatCurrency(simulationData.receitaBruta)}</span>
                </div>
                <div class="cost-item">
                    <span>(-) ICMS (12% da receita):</span>
                    <span class="text-red-400">${formatCurrency(simulationData.icmsPre)}</span>
                </div>
                <div class="cost-item">
                    <span>(-) PIS/COFINS (9,25% dos custos):</span>
                    <span class="text-red-400">${formatCurrency(simulationData.pisCofinsPre)}</span>
                </div>
                <div class="cost-item">
                    <span>(-) Custos Operacionais:</span>
                    <span class="text-red-400">${formatCurrency(simulationData.custosTotais)}</span>
                </div>
                <div class="cost-item">
                    <span>(+) Cr√©ditos Tribut√°rios:</span>
                    <span class="text-green-400">${formatCurrency(simulationData.totalCreditosPre)}</span>
                </div>
                <div class="cost-item total">
                    <span>= Lucro Operacional:</span>
                    <span class="text-xl">${formatCurrency(simulationData.lucroOperacionalPre)}</span>
                </div>
                <div class="cost-item">
                    <span>Margem:</span>
                    <span>${formatPercentage(simulationData.margemPre)}</span>
                </div>
            `;

            document.getElementById('pos-reforma-content').innerHTML = `
                <div class="cost-item">
                    <span>Receita Bruta:</span>
                    <span>${formatCurrency(simulationData.receitaBruta)}</span>
                </div>
                <div class="cost-item">
                    <span>(-) IBS (17,7% da receita):</span>
                    <span class="text-red-400">${formatCurrency(simulationData.ibsPos)}</span>
                </div>
                <div class="cost-item">
                    <span>(-) CBS (8,8% dos custos):</span>
                    <span class="text-red-400">${formatCurrency(simulationData.cbsPos)}</span>
                </div>
                <div class="cost-item">
                    <span>(-) Custos Operacionais:</span>
                    <span class="text-red-400">${formatCurrency(simulationData.custosTotais)}</span>
                </div>
                <div class="cost-item">
                    <span>(+) Cr√©ditos Tribut√°rios:</span>
                    <span class="text-green-400">${formatCurrency(simulationData.totalCreditosPos)}</span>
                </div>
                <div class="cost-item total">
                    <span>= Lucro Operacional:</span>
                    <span class="text-xl">${formatCurrency(simulationData.lucroOperacionalPos)}</span>
                </div>
                <div class="cost-item">
                    <span>Margem:</span>
                    <span>${formatPercentage(simulationData.margemPos)}</span>
                </div>
            `;

            const impactoClass = simulationData.diferencaLucro >= 0 ? 'positive' : 'negative';
            const impactoIcon = simulationData.diferencaLucro >= 0 ? 'üìà' : 'üìâ';
            
            document.getElementById('impacto-final').innerHTML = `
                <div class="${impactoClass}">
                    ${impactoIcon} ${simulationData.diferencaLucro >= 0 ? 'Aumento' : 'Redu√ß√£o'}: 
                    ${formatCurrency(Math.abs(simulationData.diferencaLucro))}
                </div>
                <div class="mt-2">Varia√ß√£o: ${simulationData.diferencaPercentual.toFixed(1)}%</div>
                ${simulationData.diferencaLucro < 0 ? `<div class="mt-4">üí° Reajuste sugerido: ${simulationData.reajusteNecessario.toFixed(1)}%</div>` : ''}
            `;

            document.getElementById('observacoes').innerHTML = '* Regime tribut√°rio de Lucro Real';
            
            document.getElementById('resumo-executivo').innerHTML = `
                <div>‚Ä¢ <strong>Carga tribut√°ria atual:</strong> ${formatPercentage((simulationData.icmsPre + simulationData.pisCofinsPre) / simulationData.receitaBruta)}</div>
                <div>‚Ä¢ <strong>Carga tribut√°ria futura:</strong> ${formatPercentage((simulationData.ibsPos + simulationData.cbsPos) / simulationData.receitaBruta)}</div>
                <div>‚Ä¢ <strong>Cr√©ditos aumentam:</strong> de ${formatCurrency(simulationData.totalCreditosPre)} para ${formatCurrency(simulationData.totalCreditosPos)}</div>
                <div>‚Ä¢ <strong>Recomenda√ß√£o:</strong> ${simulationData.diferencaLucro < 0 ? 'Revisar estrutura de custos e negociar reajustes' : 'Aproveitar melhoria de margem para expans√£o'}</div>
            `;
        }

        function displayTomadorResults() {
            document.getElementById('pre-reforma-content').innerHTML = `
                <div class="cost-item">
                    <span>Custo Contratado:</span>
                    <span>${formatCurrency(simulationData.custoFrete)}</span>
                </div>
                <div class="cost-item">
                    <span>(-) Cr√©dito ICMS (2,4%):</span>
                    <span class="text-green-400">${formatCurrency(simulationData.creditoIcmsPre)}</span>
                </div>
                <div class="cost-item">
                    <span>(-) Cr√©dito PIS/COFINS (9,25%):</span>
                    <span class="text-green-400">${formatCurrency(simulationData.creditoPisCofinsPre)}</span>
                </div>
                <div class="cost-item">
                    <span>Total de Cr√©ditos:</span>
                    <span class="text-green-400">${formatCurrency(simulationData.totalCreditosPre)}</span>
                </div>
                <div class="cost-item total">
                    <span>= Custo Efetivo:</span>
                    <span class="text-xl">${formatCurrency(simulationData.custoEfetivoPre)}</span>
                </div>
            `;

            document.getElementById('pos-reforma-content').innerHTML = `
                <div class="cost-item">
                    <span>Custo Contratado:</span>
                    <span>${formatCurrency(simulationData.custoFrete)}</span>
                </div>
                <div class="cost-item">
                    <span>(-) Cr√©dito IBS (17,7%):</span>
                    <span class="text-green-400">${formatCurrency(simulationData.creditoIbsPos)}</span>
                </div>
                <div class="cost-item">
                    <span>(-) Cr√©dito CBS (8,8%):</span>
                    <span class="text-green-400">${formatCurrency(simulationData.creditoCbsPos)}</span>
                </div>
                <div class="cost-item">
                    <span>Total de Cr√©ditos:</span>
                    <span class="text-green-400">${formatCurrency(simulationData.totalCreditosPos)}</span>
                </div>
                <div class="cost-item total">
                    <span>= Custo Efetivo:</span>
                    <span class="text-xl">${formatCurrency(simulationData.custoEfetivoPos)}</span>
                </div>
            `;

            document.getElementById('impacto-final').innerHTML = `
                <div class="positive">
                    üí∞ Economia: ${formatCurrency(simulationData.reducaoCusto)}
                </div>
                <div class="mt-2">Redu√ß√£o: ${simulationData.economiaPercentual.toFixed(1)}%</div>
                <div class="mt-4">‚ö†Ô∏è Transportador pode propor reajuste de at√© 6,2%</div>
            `;

            document.getElementById('observacoes').innerHTML = '* Consideramos 20% como m√©dia de mercado para cr√©dito ICMS';
            
            document.getElementById('resumo-executivo').innerHTML = `
                <div>‚Ä¢ <strong>Economia inicial:</strong> ${formatCurrency(simulationData.reducaoCusto)} (${simulationData.economiaPercentual.toFixed(1)}%)</div>
                <div>‚Ä¢ <strong>Cr√©ditos atuais:</strong> ${formatCurrency(simulationData.totalCreditosPre)} (${((simulationData.totalCreditosPre / simulationData.custoFrete) * 100).toFixed(1)}% do frete)</div>
                <div>‚Ä¢ <strong>Cr√©ditos futuros:</strong> ${formatCurrency(simulationData.totalCreditosPos)} (${((simulationData.totalCreditosPos / simulationData.custoFrete) * 100).toFixed(1)}% do frete)</div>
                <div>‚Ä¢ <strong>Recomenda√ß√£o:</strong> Aproveitar economia para renegociar contratos</div>
            `;
        }

        // Criar Gr√°ficos
        function createCharts() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js n√£o est√° carregado');
                return;
            }
            
            // Destruir gr√°ficos anteriores se existirem
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            const isPrestador = simulationData.tipo === 'prestador';
            
            // 1. Gr√°fico de Compara√ß√£o de Cen√°rios
            const ctx1 = document.getElementById('scenarioComparisonChart');
            if (ctx1) {
                charts.comparison = new Chart(ctx1.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Pr√©-Reforma', 'P√≥s-Reforma'],
                        datasets: [{
                            label: isPrestador ? 'Lucro Operacional' : 'Custo Efetivo',
                            data: isPrestador 
                                ? [simulationData.lucroOperacionalPre, simulationData.lucroOperacionalPos]
                                : [simulationData.custoEfetivoPre, simulationData.custoEfetivoPos],
                            backgroundColor: ['#011334', '#E1FF00'],
                            borderColor: ['#011334', '#011334'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: (value) => formatCurrency(value),
                                    color: '#011334'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#011334',
                                    font: {
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            // 2. Gr√°fico de Composi√ß√£o de Custos (apenas para prestador)
            if (isPrestador) {
                const ctx2 = document.getElementById('costBreakdownChart');
                if (ctx2) {
                    charts.costBreakdown = new Chart(ctx2.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Diesel', 'Ped√°gio', 'Manuten√ß√£o', 'Rastreamento', 'M√£o de obra', 'Deprecia√ß√£o', 'Outros'],
                            datasets: [{
                                data: [
                                    simulationData.custoDiesel * 100,
                                    simulationData.custoPedagio * 100,
                                    simulationData.custoManutencao * 100,
                                    simulationData.custoRastreamento * 100,
                                    simulationData.custoMaoObra * 100,
                                    simulationData.custoDepreciacao * 100,
                                    simulationData.custoOutros * 100
                                ],
                                backgroundColor: [
                                    '#011334',
                                    '#E1FF00',
                                    '#10b981',
                                    '#3b82f6',
                                    '#f59e0b',
                                    '#ef4444',
                                    '#8b5cf6'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        padding: 10,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => {
                                            return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // 3. Gr√°fico de Evolu√ß√£o dos Cr√©ditos
            const ctx3 = document.getElementById('creditsEvolutionChart');
            if (ctx3) {
                if (isPrestador) {
                    charts.creditsEvolution = new Chart(ctx3.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['Receita', 'D√©bitos', 'Cr√©ditos', 'Resultado'],
                            datasets: [
                                {
                                    label: 'Pr√©-Reforma',
                                    data: [
                                        simulationData.receitaBruta,
                                        simulationData.receitaBruta - simulationData.icmsPre - simulationData.pisCofinsPre,
                                        simulationData.receitaBruta - simulationData.icmsPre - simulationData.pisCofinsPre + simulationData.totalCreditosPre,
                                        simulationData.lucroOperacionalPre
                                    ],
                                    borderColor: '#011334',
                                    backgroundColor: 'rgba(1, 19, 52, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.3,
                                    pointRadius: 5,
                                    pointHoverRadius: 7,
                                    pointBackgroundColor: '#011334'
                                },
                                {
                                    label: 'P√≥s-Reforma',
                                    data: [
                                        simulationData.receitaBruta,
                                        simulationData.receitaBruta - simulationData.ibsPos - simulationData.cbsPos,
                                        simulationData.receitaBruta - simulationData.ibsPos - simulationData.cbsPos + simulationData.totalCreditosPos,
                                        simulationData.lucroOperacionalPos
                                    ],
                                    borderColor: '#E1FF00',
                                    backgroundColor: 'rgba(225, 255, 0, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.3,
                                    pointRadius: 5,
                                    pointHoverRadius: 7,
                                    pointBackgroundColor: '#E1FF00'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12
                                        },
                                        color: '#011334'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => {
                                            return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: (value) => formatCurrency(value),
                                        color: '#011334'
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#011334',
                                        font: {
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                } else {
                    // Para tomador
                    charts.creditsEvolution = new Chart(ctx3.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['Custo Contratado', 'Cr√©ditos', 'Custo Efetivo'],
                            datasets: [
                                {
                                    label: 'Pr√©-Reforma',
                                    data: [
                                        simulationData.custoFrete,
                                        simulationData.custoFrete - simulationData.totalCreditosPre,
                                        simulationData.custoEfetivoPre
                                    ],
                                    borderColor: '#011334',
                                    backgroundColor: 'rgba(1, 19, 52, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.3,
                                    pointRadius: 5,
                                    pointHoverRadius: 7,
                                    pointBackgroundColor: '#011334'
                                },
                                {
                                    label: 'P√≥s-Reforma',
                                    data: [
                                        simulationData.custoFrete,
                                        simulationData.custoFrete - simulationData.totalCreditosPos,
                                        simulationData.custoEfetivoPos
                                    ],
                                    borderColor: '#E1FF00',
                                    backgroundColor: 'rgba(225, 255, 0, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.3,
                                    pointRadius: 5,
                                    pointHoverRadius: 7,
                                    pointBackgroundColor: '#E1FF00'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12
                                        },
                                        color: '#011334'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => {
                                            return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: (value) => formatCurrency(value),
                                        color: '#011334'
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#011334',
                                        font: {
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // 4. Gr√°fico de An√°lise de Impacto
            const ctx4 = document.getElementById('impactAnalysisChart');
            if (ctx4) {
                const impactData = isPrestador 
                    ? {
                        labels: ['ICMS', 'PIS/COFINS', 'IBS', 'CBS'],
                        preData: [simulationData.icmsPre, simulationData.pisCofinsPre, 0, 0],
                        posData: [0, 0, simulationData.ibsPos, simulationData.cbsPos]
                    }
                    : {
                        labels: ['Cr√©dito ICMS', 'Cr√©dito PIS/COFINS', 'Cr√©dito IBS', 'Cr√©dito CBS'],
                        preData: [simulationData.creditoIcmsPre, simulationData.creditoPisCofinsPre, 0, 0],
                        posData: [0, 0, simulationData.creditoIbsPos, simulationData.creditoCbsPos]
                    };
                
                charts.impactAnalysis = new Chart(ctx4.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: impactData.labels,
                        datasets: [
                            {
                                label: 'Pr√©-Reforma',
                                data: impactData.preData,
                                backgroundColor: '#011334',
                                borderColor: '#011334',
                                borderWidth: 2
                            },
                            {
                                label: 'P√≥s-Reforma',
                                data: impactData.posData,
                                backgroundColor: '#E1FF00',
                                borderColor: '#011334',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    },
                                    color: '#011334'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => formatCurrency(value),
                                    color: '#011334'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#011334',
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
            
            console.log('‚úÖ Todos os gr√°ficos criados com sucesso!');
        }

        // Gerar PDF - VERS√ÉO SIMPLIFICADA E FUNCIONAL
        async function generatePDF() {
            // Verificar se h√° resultados
            const resultSection = document.getElementById('resultados');
            if (!resultSection || resultSection.classList.contains('hidden')) {
                alert('Por favor, fa√ßa uma simula√ß√£o antes de gerar o PDF.');
                return;
            }
            
            // Mostrar loading
            const btnPdf = document.getElementById('btn-baixar-pdf');
            const textOriginal = btnPdf ? btnPdf.innerHTML : '';
            if (btnPdf) {
                btnPdf.innerHTML = '‚è≥ Gerando PDF...';
                btnPdf.disabled = true;
            }
            
            try {
                // Aguardar um momento para garantir que tudo est√° renderizado
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Capturar a se√ß√£o de resultados usando html2canvas
                const canvas = await html2canvas(resultSection, {
                    scale: 2, // Boa qualidade
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#F2F2F2',
                    logging: false,
                    width: resultSection.scrollWidth,
                    height: resultSection.scrollHeight,
                    windowWidth: resultSection.scrollWidth,
                    windowHeight: resultSection.scrollHeight
                });
                
                // Criar PDF usando jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Adicionar cabe√ßalho com dados da empresa
                pdf.setFillColor(1, 19, 52);
                pdf.rect(0, 0, 210, 40, 'F');
                
                // Logo (texto como fallback)
                pdf.setTextColor(225, 255, 0);
                pdf.setFontSize(20);
                pdf.setFont('helvetica', 'bold');
                pdf.text('PEERS', 20, 20);
                
                // T√≠tulo
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(16);
                pdf.text('Relat√≥rio de Simula√ß√£o - Reforma Tribut√°ria', 105, 20, { align: 'center' });
                
                // Data
                pdf.setFontSize(10);
                pdf.text(new Date().toLocaleDateString('pt-BR'), 190, 20, { align: 'right' });
                
                // Dados da empresa
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(10);
                if (leadData.empresa) {
                    pdf.text(`Empresa: ${leadData.empresa}`, 20, 30);
                }
                if (leadData.nome) {
                    pdf.text(`Respons√°vel: ${leadData.nome}`, 20, 35);
                }
                
                // Adicionar a imagem capturada
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const imgWidth = 190; // Largura da imagem no PDF (mm)
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Adicionar imagem ao PDF
                pdf.addImage(imgData, 'JPEG', 10, 45, imgWidth, imgHeight);
                
                // Se a imagem for muito grande, adicionar p√°ginas
                let heightLeft = imgHeight - (297 - 45); // 297mm = altura A4, 45mm = in√≠cio da imagem
                let position = 45;
                
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
                    heightLeft -= 297;
                }
                
                // Adicionar rodap√© na √∫ltima p√°gina
                const pageCount = pdf.internal.getNumberOfPages();
                pdf.setPage(pageCount);
                
                // Rodap√©
                pdf.setFontSize(8);
                pdf.setTextColor(100);
                pdf.text('Simula√ß√£o baseada em EC 132/2023 e PLP 68/2024', 105, 285, { align: 'center' });
                pdf.text('www.peers.com.br', 105, 290, { align: 'center' });
                
                // Salvar o PDF
                pdf.save(`Simulacao_Reforma_PEERS_${new Date().getTime()}.pdf`);
                
                // Restaurar bot√£o
                if (btnPdf) {
                    btnPdf.innerHTML = textOriginal;
                    btnPdf.disabled = false;
                }
                
                console.log('‚úÖ PDF gerado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar o PDF. Por favor, tente novamente ou use a fun√ß√£o de impress√£o do navegador (Ctrl+P).');
                
                // Restaurar bot√£o
                if (btnPdf) {
                    btnPdf.innerHTML = textOriginal;
                    btnPdf.disabled = false;
                }
            }
        }
        
        // Fun√ß√£o alternativa - Imprimir
        function printResults() {
            window.print();
        }
        
        // Fun√ß√£o simplificada que ser√° chamada
        function generateFullPagePDF() {
            generatePDF();
        }
    </script>
</body>
</html>