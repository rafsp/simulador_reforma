<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Reforma Tribut√°ria - PEERS</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Custom styles based on PEERS Brandbook */
        :root {
            --peers-blue: #011334;
            --peers-blue-dark: #001026;
            --peers-lime: #E1FF00;
            --peers-white: #FFFFFF;
            --peers-light-gray: #F2F2F2;
            --peers-medium-gray: #E5E7EB;
            --peers-text-gray: #6b7280;
            --peers-dark-gray: #374151;
            --peers-success: #10b981;
            --peers-danger: #ef4444;
            --peers-warning: #f59e0b;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--peers-light-gray);
            line-height: 1.6;
            color: var(--peers-dark-gray);
        }
        
        /* Logo styles */
        .peers-logo-svg {
            height: 40px;
            width: auto;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Enhanced Card Styles */
        .peers-card {
            background: var(--peers-white);
            border-radius: 1.5rem;
            box-shadow: 0 4px 20px rgba(1, 19, 52, 0.08);
            padding: 2.5rem;
            margin-bottom: 2rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .peers-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--peers-lime) 0%, var(--peers-blue) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .peers-card:hover::before {
            opacity: 1;
        }
        
        /* Header Styles */
        .peers-header {
            background: linear-gradient(135deg, var(--peers-blue) 0%, var(--peers-blue-dark) 100%);
            color: var(--peers-white);
            text-align: center;
            padding: 3rem 1.5rem;
            border-radius: 1.5rem;
            margin-bottom: 2.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .peers-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(225, 255, 0, 0.1) 0%, transparent 70%);
        }
        
        /* Button Styles */
        .peers-btn {
            background: var(--peers-lime);
            color: var(--peers-blue);
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(225, 255, 0, 0.3);
        }
        
        .peers-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(225, 255, 0, 0.4);
        }
        
        .peers-btn:active {
            transform: translateY(0);
        }
        
        .peers-btn-secondary {
            background: var(--peers-blue);
            color: var(--peers-white);
            box-shadow: 0 4px 15px rgba(1, 19, 52, 0.3);
        }
        
        .peers-btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(1, 19, 52, 0.4);
        }
        
        /* Input Styles */
        .peers-input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .peers-input, .peers-select {
            width: 100%;
            padding: 1rem 1.25rem;
            padding-left: 3rem;
            border: 2px solid var(--peers-medium-gray);
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--peers-white);
        }
        
        .peers-input:focus, .peers-select:focus {
            outline: none;
            border-color: var(--peers-lime);
            box-shadow: 0 0 0 4px rgba(225, 255, 0, 0.1);
        }
        
        .peers-input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--peers-text-gray);
            pointer-events: none;
        }
        
        .peers-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--peers-blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Profile Selection */
        .profile-option {
            border: 3px solid var(--peers-medium-gray);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: var(--peers-white);
        }
        
        .profile-option:hover {
            border-color: var(--peers-lime);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(1, 19, 52, 0.1);
        }
        
        .profile-option.active {
            border-color: var(--peers-lime);
            background: linear-gradient(135deg, rgba(225, 255, 0, 0.05) 0%, rgba(225, 255, 0, 0.1) 100%);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(225, 255, 0, 0.2);
        }
        
        .profile-icon {
            width: 60px;
            height: 60px;
            background: var(--peers-light-gray);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 1rem;
            transition: all 0.3s ease;
        }
        
        .profile-option.active .profile-icon {
            background: var(--peers-lime);
            color: var(--peers-blue);
        }
        
        /* Results Section */
        .results-section {
            background: linear-gradient(135deg, var(--peers-blue) 0%, var(--peers-blue-dark) 100%);
            color: var(--peers-white);
            border-radius: 1.5rem;
            padding: 3rem;
            margin-top: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .scenario-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 1.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(229, 231, 235, 0.1);
            transition: all 0.2s ease;
        }
        
        .cost-item:hover {
            padding-left: 0.5rem;
        }
        
        .cost-item:last-child {
            border-bottom: none;
        }
        
        .cost-item.total {
            margin-top: 1rem;
            padding-top: 1.25rem;
            border-top: 2px solid var(--peers-lime);
            font-weight: 600;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin: 2rem 0;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* Value Highlights */
        .value-highlight {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--peers-lime);
            text-shadow: 0 2px 10px rgba(225, 255, 0, 0.3);
        }
        
        .positive { 
            color: var(--peers-success);
            text-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }
        
        .negative { 
            color: var(--peers-danger);
            text-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--peers-medium-gray);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--peers-lime) 0%, var(--peers-success) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .progress-fill.warning {
            background: linear-gradient(90deg, var(--peers-warning) 0%, var(--peers-danger) 100%);
        }
        
        /* Tooltip Styles */
        .tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: help;
        }
        
        .tooltip-icon {
            width: 18px;
            height: 18px;
            background: var(--peers-medium-gray);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--peers-dark-gray);
            transition: all 0.2s ease;
        }
        
        .tooltip:hover .tooltip-icon {
            background: var(--peers-lime);
            color: var(--peers-blue);
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: var(--peers-blue);
            color: var(--peers-white);
            text-align: left;
            border-radius: 0.75rem;
            padding: 1rem;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            line-height: 1.5;
            box-shadow: 0 10px 30px rgba(1, 19, 52, 0.3);
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--peers-blue) transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(-5px);
        }
        
        /* PDF specific styles */
        .pdf-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 0 auto;
            background: white;
            position: relative;
        }
        
        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--peers-lime);
            margin-bottom: 30px;
        }
        
        .pdf-section {
            margin-bottom: 30px;
        }
        
        .pdf-chart-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            text-align: center;
        }
        
        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--peers-medium-gray);
            border-radius: 50%;
            border-top-color: var(--peers-lime);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .peers-card {
                padding: 1.5rem;
            }
            
            .peers-header {
                padding: 2rem 1rem;
            }
            
            .peers-logo-svg {
                height: 30px;
            }
            
            .results-section {
                padding: 2rem 1.5rem;
            }
            
            .chart-container {
                height: 250px;
            }
        }
        
        /* Smooth transitions for visibility changes */
        .hidden {
            display: none !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Print styles */
        @media print {
            body { background: white; }
            .peers-btn, #progress-indicator, .no-print { display: none !important; }
            .peers-card, .results-section { 
                box-shadow: none !important; 
                page-break-inside: avoid;
            }
            .hidden { display: none !important; }
        }
    </style>
</head>
<body class="antialiased">
    <div class="max-w-5xl mx-auto p-5">
        <!-- Header -->
        <div class="peers-header">
            <img src="https://d3fh32tca5cd7q.cloudfront.net/wp-content/uploads/2025/03/logo.svg" 
                 alt="PEERS Logo" 
                 class="peers-logo-svg mx-auto mb-4"
                 style="filter: brightness(0) saturate(100%) invert(93%) sepia(93%) saturate(2000%) hue-rotate(21deg) brightness(104%) contrast(105%);">
            <p class="text-sm opacity-90 mb-4">Consulting + Technology</p>
            <h1 class="text-3xl md:text-4xl font-semibold mb-3">Simulador de Reforma Tribut√°ria</h1>
            <p class="text-base md:text-lg opacity-90 max-w-2xl mx-auto">
                Descubra como a nova legisla√ß√£o tribut√°ria impactar√° seus custos de transporte e prepare-se para o futuro
            </p>
        </div>

        <!-- Progress Indicator -->
        <div id="progress-indicator" class="peers-card mb-4 hidden">
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium" style="color: var(--peers-blue);">Progresso da simula√ß√£o</span>
                <span id="progress-text" class="text-sm font-medium" style="color: var(--peers-text-gray);">0%</span>
            </div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Lead Capture Form (Modified to be at the end) -->
        <div id="lead-form" class="peers-card animate-fade-in hidden">
            <div class="text-center mb-8">
                <h2 class="text-2xl md:text-3xl font-semibold mb-3" style="color: var(--peers-blue);">
                    Complete seu cadastro
                </h2>
                <p class="text-base" style="color: var(--peers-text-gray);">
                    Para receber o relat√≥rio completo da simula√ß√£o
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                <div class="peers-input-group">
                    <label for="lead-nome" class="peers-label">
                        Nome completo
                        <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <span class="peers-input-icon">üë§</span>
                        <input type="text" id="lead-nome" class="peers-input" placeholder="Jo√£o Silva" required>
                    </div>
                </div>
                
                <div class="peers-input-group">
                    <label for="lead-empresa" class="peers-label">
                        Empresa
                        <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <span class="peers-input-icon">üè¢</span>
                        <input type="text" id="lead-empresa" class="peers-input" placeholder="Transportadora ABC" required>
                    </div>
                </div>
                
                <div class="peers-input-group">
                    <label for="lead-cargo" class="peers-label">
                        Cargo
                    </label>
                    <div class="relative">
                        <span class="peers-input-icon">üíº</span>
                        <input type="text" id="lead-cargo" class="peers-input" placeholder="Gerente de Opera√ß√µes">
                    </div>
                </div>
                
                <div class="peers-input-group">
                    <label for="lead-email" class="peers-label">
                        E-mail corporativo
                        <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <span class="peers-input-icon">‚úâÔ∏è</span>
                        <input type="email" id="lead-email" class="peers-input" placeholder="joao@empresa.com" required>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-8">
                <button class="peers-btn px-12 py-4 text-lg" onclick="validateLeadAndProceed()">
                    <span>Gerar Relat√≥rio PDF ‚Üí</span>
                </button>
                <p class="text-xs mt-4" style="color: var(--peers-text-gray);">
                    Seus dados est√£o seguros e n√£o ser√£o compartilhados
                </p>
            </div>
        </div>

        <!-- Profile Selector (Now shown first) -->
        <div id="profile-selector" class="peers-card">
            <div class="text-center mb-8">
                <h2 class="text-2xl md:text-3xl font-semibold mb-3" style="color: var(--peers-blue);">
                    Qual √© o seu perfil?
                </h2>
                <p class="text-base" style="color: var(--peers-text-gray);">
                    Escolha a op√ß√£o que melhor descreve sua opera√ß√£o
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                <div class="profile-option p-8 text-center rounded-xl" id="tomador" onclick="selectProfile('tomador')">
                    <div class="profile-icon">üì¶</div>
                    <h3 class="font-semibold text-xl mb-2" style="color: var(--peers-blue);">
                        Contratante
                    </h3>
                    <p class="text-sm mb-3" style="color: var(--peers-text-gray);">
                        Sua empresa contrata transportadoras para movimentar suas cargas
                    </p>
                    <div class="text-xs" style="color: var(--peers-text-gray);">
                        ‚Ä¢ Ind√∫strias<br>
                        ‚Ä¢ Distribuidores<br>
                        ‚Ä¢ Varejistas
                    </div>
                </div>
                
                <div class="profile-option p-8 text-center rounded-xl" id="prestador" onclick="selectProfile('prestador')">
                    <div class="profile-icon">üöö</div>
                    <h3 class="font-semibold text-xl mb-2" style="color: var(--peers-blue);">
                        Transportadora
                    </h3>
                    <p class="text-sm mb-3" style="color: var(--peers-text-gray);">
                        Sua empresa presta servi√ßos de transporte rodovi√°rio de cargas
                    </p>
                    <div class="text-xs" style="color: var(--peers-text-gray);">
                        ‚Ä¢ Transportadoras<br>
                        ‚Ä¢ Operadores log√≠sticos<br>
                        ‚Ä¢ Aut√¥nomos
                    </div>
                </div>
            </div>
        </div>

        <!-- Prestador Form -->
        <div id="prestador-form" class="hidden">
            <div class="peers-card animate-fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold" style="color: var(--peers-blue);">
                        Informa√ß√µes Financeiras
                    </h2>
                    <button onclick="showExample('prestador')" class="text-sm font-medium" style="color: var(--peers-lime); background: var(--peers-blue); padding: 0.5rem 1rem; border-radius: 0.5rem;">
                        Ver exemplo
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="peers-input-group">
                        <label for="receita-bruta" class="peers-label">
                            Receita Bruta Anual
                            <div class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">
                                    Valor total faturado com presta√ß√£o de servi√ßos de transporte nos √∫ltimos 12 meses, sem dedu√ß√µes
                                </span>
                            </div>
                        </label>
                        <div class="relative">
                            <span class="peers-input-icon">R$</span>
                            <input type="text" id="receita-bruta" class="peers-input" placeholder="0,00" 
                                   oninput="formatInputCurrency(this)" onfocus="this.select()">
                        </div>
                    </div>
                    
                    <div class="peers-input-group">
                        <label for="custos-totais" class="peers-label">
                            Custos Operacionais Totais
                            <div class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">
                                    Soma de todos os custos diretos e indiretos da opera√ß√£o de transporte, incluindo combust√≠vel, manuten√ß√£o, pessoal, etc.
                                </span>
                            </div>
                        </label>
                        <div class="relative">
                            <span class="peers-input-icon">R$</span>
                            <input type="text" id="custos-totais" class="peers-input" placeholder="0,00" 
                                   oninput="formatInputCurrency(this)" onfocus="this.select()">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="peers-card animate-fade-in" style="animation-delay: 0.1s;">
                <h3 class="text-xl font-semibold mb-6" style="color: var(--peers-blue);">
                    Composi√ß√£o dos Custos
                    <span class="text-sm font-normal ml-2" style="color: var(--peers-text-gray);">
                        (Distribua o total de 100% entre as categorias)
                    </span>
                </h3>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label class="peers-label">
                            <span style="display: inline-block; width: 20px;">‚õΩ</span> Diesel
                            <div class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">
                                    Combust√≠vel utilizado na frota. Este √© um insumo credit√°vel em ambos os cen√°rios tribut√°rios
                                </span>
                            </div>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-diesel-range" min="0" max="100" value="35" step="1"
                                   oninput="updateCostFromRange('diesel')" class="flex-1">
                            <input type="number" id="custo-diesel" class="w-20 p-2 border rounded text-center" 
                                   value="35" min="0" max="100" oninput="updateRangeFromInput('diesel')">
                            <span>%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="peers-label">
                            <span style="display: inline-block; width: 20px;">üõ£Ô∏è</span> Ped√°gio
                            <div class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">
                                    Custos com ped√°gios nas rodovias. Insumo credit√°vel na reforma tribut√°ria
                                </span>
                            </div>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-pedagio-range" min="0" max="100" value="6" step="1"
                                   oninput="updateCostFromRange('pedagio')" class="flex-1">
                            <input type="number" id="custo-pedagio" class="w-20 p-2 border rounded text-center" 
                                   value="6" min="0" max="100" oninput="updateRangeFromInput('pedagio')">
                            <span>%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="peers-label">
                            <span style="display: inline-block; width: 20px;">üîß</span> Manuten√ß√£o
                            <div class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">
                                    Pe√ßas, servi√ßos mec√¢nicos e manuten√ß√£o preventiva. Credit√°vel na reforma
                                </span>
                            </div>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-manutencao-range" min="0" max="100" value="6" step="1"
                                   oninput="updateCostFromRange('manutencao')" class="flex-1">
                            <input type="number" id="custo-manutencao" class="w-20 p-2 border rounded text-center" 
                                   value="6" min="0" max="100" oninput="updateRangeFromInput('manutencao')">
                            <span>%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="peers-label">
                            <span style="display: inline-block; width: 20px;">üìç</span> Rastreamento/Pneus
                            <div class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">
                                    Sistemas de rastreamento, telemetria e pneus. Credit√°vel na reforma
                                </span>
                            </div>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-rastreamento-range" min="0" max="100" value="6" step="1"
                                   oninput="updateCostFromRange('rastreamento')" class="flex-1">
                            <input type="number" id="custo-rastreamento" class="w-20 p-2 border rounded text-center" 
                                   value="6" min="0" max="100" oninput="updateRangeFromInput('rastreamento')">
                            <span>%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="peers-label">
                            <span style="display: inline-block; width: 20px;">üë•</span> M√£o de obra
                            <div class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">
                                    Sal√°rios, benef√≠cios e encargos de motoristas. N√£o credit√°vel
                                </span>
                            </div>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-mao-obra-range" min="0" max="100" value="25" step="1"
                                   oninput="updateCostFromRange('mao-obra')" class="flex-1">
                            <input type="number" id="custo-mao-obra" class="w-20 p-2 border rounded text-center" 
                                   value="25" min="0" max="100" oninput="updateRangeFromInput('mao-obra')">
                            <span>%</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="peers-label">
                            <span style="display: inline-block; width: 20px;">üìä</span> Deprecia√ß√£o/Seguro
                            <div class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">
                                    Deprecia√ß√£o de ve√≠culos e seguros obrigat√≥rios. N√£o credit√°vel
                                </span>
                            </div>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="custo-depreciacao-range" min="0" max="100" value="6" step="1"
                                   oninput="updateCostFromRange('depreciacao')" class="flex-1">
                            <input type="number" id="custo-depreciacao" class="w-20 p-2 border rounded text-center" 
                                   value="6" min="0" max="100" oninput="updateRangeFromInput('depreciacao')">
                            <span>%</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 p-4 rounded-xl" style="background: var(--peers-light-gray);">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium" style="color: var(--peers-blue);">Total dos custos especificados:</span>
                        <span id="total-custos-percent" class="text-2xl font-bold" style="color: var(--peers-blue);">84%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="cost-progress-fill" class="progress-fill" style="width: 84%"></div>
                    </div>
                    <p id="cost-info" class="text-sm mt-2" style="color: var(--peers-text-gray);">
                        Os 16% restantes ser√£o classificados como "Outros custos (admin e fixos)"
                    </p>
                    <p id="cost-warning" class="text-sm mt-2 hidden" style="color: var(--peers-danger);">
                        ‚ö†Ô∏è A soma ultrapassou 100%. Ajuste os valores.
                    </p>
                </div>
            </div>
            
            <div class="text-center mt-8">
                <button class="peers-btn px-12 py-4 text-lg" onclick="calcularPrestador()">
                    <span>Calcular Impacto ‚Üí</span>
                </button>
            </div>
        </div>

        <!-- Tomador Form -->
        <div id="tomador-form" class="hidden">
            <div class="peers-card animate-fade-in">
                <div class="text-center mb-8">
                    <h2 class="text-2xl md:text-3xl font-semibold mb-3" style="color: var(--peers-blue);">
                        Quanto voc√™ gasta com frete?
                    </h2>
                    <p class="text-base" style="color: var(--peers-text-gray);">
                        Informe o valor total anual gasto com contrata√ß√£o de transportadoras
                    </p>
                </div>
                
                <div class="max-w-md mx-auto">
                    <div class="peers-input-group">
                        <label for="custo-frete" class="peers-label text-lg">
                            Custo Total com Frete (√∫ltimos 12 meses)
                            <div class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">
                                    Valor total pago para transportadoras, incluindo frete, seguro de carga e outros custos relacionados ao transporte
                                </span>
                            </div>
                        </label>
                        <div class="relative">
                            <span class="peers-input-icon text-xl">R$</span>
                            <input type="text" id="custo-frete" class="peers-input text-xl py-4 pl-12" 
                                   placeholder="0,00" oninput="formatInputCurrency(this)" onfocus="this.select()">
                        </div>
                        <p class="text-sm mt-2" style="color: var(--peers-text-gray);">
                            Exemplo: R$ 10.000.000,00
                        </p>
                    </div>
                </div>
                
                <div class="text-center mt-8">
                    <button class="peers-btn px-12 py-4 text-lg" onclick="calcularTomador()">
                        <span>Calcular Economia ‚Üí</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="resultados" class="hidden">
            <div class="results-section animate-fade-in">
                <div class="text-center mb-8">
                    <h2 class="text-3xl md:text-4xl font-semibold mb-3">
                        An√°lise do Impacto Tribut√°rio
                    </h2>
                    <p class="text-lg opacity-90">
                        Comparativo entre o cen√°rio atual e a nova legisla√ß√£o
                    </p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="scenario-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">üìã Cen√°rio Atual</h3>
                            <span class="text-sm opacity-75">Pr√©-Reforma</span>
                        </div>
                        <div id="pre-reforma-content"></div>
                    </div>
                    
                    <div class="scenario-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">üöÄ Cen√°rio Futuro</h3>
                            <span class="text-sm opacity-75">P√≥s-Reforma</span>
                        </div>
                        <div id="pos-reforma-content"></div>
                    </div>
                </div>
                
                <div class="text-center p-8 rounded-xl" style="background: rgba(225, 255, 0, 0.15);">
                    <h3 class="text-2xl font-semibold mb-4">üí° Impacto Final</h3>
                    <div id="impacto-final" class="value-highlight mb-4"></div>
                    <div id="observacoes" class="text-sm opacity-90"></div>
                </div>
                
                <!-- Charts Section -->
                <div id="charts-section" class="mt-8 hidden">
                    <h3 class="text-xl font-semibold mb-4 text-center">üìä Visualiza√ß√£o dos Dados</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="chart-card">
                            <h4 class="text-lg font-medium mb-3">Quebra dos Custos Operacionais</h4>
                            <div class="chart-container">
                                <canvas id="costBreakdownChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h4 class="text-lg font-medium mb-3">Comparativo de Cen√°rios</h4>
                            <div class="chart-container">
                                <canvas id="scenarioComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-card mt-6">
                        <h4 class="text-lg font-medium mb-3">Insumos Credit√°veis</h4>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="creditableInputsChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 p-6 rounded-xl" style="background: rgba(255, 255, 255, 0.1);">
                    <h4 class="text-lg font-semibold mb-3">üìä Resumo Executivo</h4>
                    <div id="resumo-executivo" class="text-sm opacity-90 space-y-2"></div>
                </div>
                
                <div class="text-center mt-8 space-x-4 no-print">
                    <button class="peers-btn-secondary px-8 py-3" onclick="showLeadForm()">
                        üìß Receber por E-mail
                    </button>
                    <button class="peers-btn px-8 py-3" onclick="showLeadForm()">
                        üìÑ Baixar PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer CTA -->
        <div id="footer-cta" class="hidden">
            <div class="peers-card text-center animate-fade-in" 
                 style="background: linear-gradient(135deg, var(--peers-blue) 0%, var(--peers-blue-dark) 100%); color: var(--peers-white);">
                <h3 class="text-2xl font-semibold mb-4">
                    Quer uma an√°lise mais detalhada?
                </h3>
                <p class="mb-6 opacity-90 max-w-2xl mx-auto">
                    Nossos especialistas podem criar um relat√≥rio personalizado com estrat√©gias espec√≠ficas 
                    para sua empresa se adaptar √† reforma tribut√°ria
                </p>
                <button class="peers-btn mb-6 px-8 py-4 text-lg" onclick="agendarDiagnostico()">
                    <span>üìà Solicitar Diagn√≥stico Completo</span>
                </button>
                <div class="text-sm opacity-80 mt-6">
                    <p class="mb-2">Simula√ß√£o baseada em EC 132/2023 e PLP 68/2024</p>
                    <p><span id="user-email-display"></span> | <span id="user-empresa-display"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedProfile = '';
        let leadData = {};
        let currentStep = 0;
        const totalSteps = 3;
        let simulationData = {};
        let charts = {};

        // Chart.js default configuration
        Chart.defaults.font.family = 'Poppins';
        Chart.defaults.color = '#FFFFFF';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress(0);
        });

        // Progress tracking
        function updateProgress(step) {
            currentStep = step;
            const progressPercent = (step / totalSteps) * 100;
            
            const progressIndicator = document.getElementById('progress-indicator');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            if (step > 0) {
                progressIndicator.classList.remove('hidden');
                progressFill.style.width = progressPercent + '%';
                progressText.textContent = Math.round(progressPercent) + '%';
            }
        }

        // Currency formatting
        function formatInputCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            value = (parseInt(value) / 100).toFixed(2);
            value = value.replace('.', ',');
            value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            input.value = value;
        }

        function parseCurrency(value) {
            return parseFloat(value.replace(/\./g, '').replace(',', '.')) || 0;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { 
                style: 'currency', 
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatPercentage(value) {
            return new Intl.NumberFormat('pt-BR', { 
                style: 'percent', 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }).format(value);
        }

        // Cost sliders management
        function updateCostFromRange(type) {
            const rangeValue = document.getElementById(`custo-${type}-range`).value;
            document.getElementById(`custo-${type}`).value = rangeValue;
            updateTotalCosts();
        }

        function updateRangeFromInput(type) {
            const inputValue = document.getElementById(`custo-${type}`).value;
            document.getElementById(`custo-${type}-range`).value = inputValue;
            updateTotalCosts();
        }

        function updateTotalCosts() {
            const costs = ['diesel', 'pedagio', 'manutencao', 'rastreamento', 'mao-obra', 'depreciacao'];
            let total = 0;
            
            costs.forEach(cost => {
                const value = parseFloat(document.getElementById(`custo-${cost}`).value) || 0;
                total += value;
            });
            
            document.getElementById('total-custos-percent').textContent = total.toFixed(0) + '%';
            
            const progressFill = document.getElementById('cost-progress-fill');
            progressFill.style.width = Math.min(total, 100) + '%';
            
            const costInfo = document.getElementById('cost-info');
            const costWarning = document.getElementById('cost-warning');
            
            if (total > 100) {
                progressFill.classList.add('warning');
                costWarning.classList.remove('hidden');
                costInfo.classList.add('hidden');
            } else if (total < 100) {
                progressFill.classList.remove('warning');
                costWarning.classList.add('hidden');
                costInfo.classList.remove('hidden');
                const outros = 100 - total;
                costInfo.textContent = `Os ${outros.toFixed(0)}% restantes ser√£o classificados como "Outros custos (admin e fixos)"`;
            } else {
                progressFill.classList.remove('warning');
                costWarning.classList.add('hidden');
                costInfo.classList.add('hidden');
            }
            
            return total;
        }

        // Lead validation
        function validateLeadAndProceed() {
            const nome = document.getElementById('lead-nome').value.trim();
            const empresa = document.getElementById('lead-empresa').value.trim();
            const email = document.getElementById('lead-email').value.trim();
            
            // Remove previous errors
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            
            let hasError = false;
            
            if (!nome) {
                document.getElementById('lead-nome').classList.add('input-error');
                hasError = true;
            }
            
            if (!empresa) {
                document.getElementById('lead-empresa').classList.add('input-error');
                hasError = true;
            }
            
            if (!email) {
                document.getElementById('lead-email').classList.add('input-error');
                hasError = true;
            }
            
            if (hasError) {
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                document.getElementById('lead-email').classList.add('input-error');
                alert('Por favor, insira um e-mail v√°lido.');
                return;
            }
            
            leadData = { 
                nome, 
                empresa, 
                cargo: document.getElementById('lead-cargo').value.trim(), 
                email 
            };
            
            console.log('Lead capturado:', leadData);
            
            // Generate PDF after lead capture
            generatePDF();
            
            // Send email notification
            agendarDiagnostico();
        }

        // Profile selection
        function selectProfile(profile) {
            selectedProfile = profile;
            
            document.getElementById('tomador').classList.toggle('active', profile === 'tomador');
            document.getElementById('prestador').classList.toggle('active', profile === 'prestador');
            
            setTimeout(() => {
                document.getElementById('profile-selector').classList.add('hidden');
                document.getElementById('prestador-form').classList.toggle('hidden', profile !== 'prestador');
                document.getElementById('tomador-form').classList.toggle('hidden', profile !== 'tomador');
                document.getElementById('resultados').classList.add('hidden');
                document.getElementById('footer-cta').classList.remove('hidden');
                updateProgress(1);
            }, 300);
        }

        // Show example values
        function showExample(type) {
            if (type === 'prestador') {
                document.getElementById('receita-bruta').value = '100.000.000,00';
                document.getElementById('custos-totais').value = '75.000.000,00';
            }
        }

        // Show lead form
        function showLeadForm() {
            document.getElementById('lead-form').classList.remove('hidden');
            document.getElementById('lead-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Email
        function agendarDiagnostico() {
            const subject = encodeURIComponent('Solicita√ß√£o de Relat√≥rio Completo - Reforma Tribut√°ria');
            const body = encodeURIComponent(
                `Nome: ${leadData.nome}\n` +
                `Empresa: ${leadData.empresa}\n` +
                `Cargo: ${leadData.cargo}\n` +
                `Email: ${leadData.email}\n` +
                `Perfil: ${selectedProfile === 'tomador' ? 'Contratante' : 'Transportadora'}\n\n` +
                `Gostaria de receber um relat√≥rio completo e personalizado sobre como a Reforma Tribut√°ria ` +
                `impactar√° nossa opera√ß√£o e quais estrat√©gias podemos adotar para nos prepararmos.`
            );
            window.location.href = `mailto:contato@peers.com.br?subject=${subject}&body=${body}`;
        }

        // Chart creation functions
        function createCharts() {
            const chartsSection = document.getElementById('charts-section');
            chartsSection.classList.remove('hidden');
            
            // Destroy existing charts if any
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            if (selectedProfile === 'prestador') {
                createPrestadorCharts();
            } else {
                createTomadorCharts();
            }
        }

        function createPrestadorCharts() {
            // Cost Breakdown Chart - PEERS Style
            const costBreakdownCtx = document.getElementById('costBreakdownChart').getContext('2d');
            
            const costData = [
                simulationData.custoDiesel * 100,
                simulationData.custoPedagio * 100,
                simulationData.custoManutencao * 100,
                simulationData.custoRastreamento * 100,
                simulationData.custoMaoObra * 100,
                simulationData.custoDepreciacao * 100,
                simulationData.custoOutros * 100
            ];
            
            charts.costBreakdown = new Chart(costBreakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Diesel', 'Ped√°gio', 'Manuten√ß√£o', 'Rastreamento + Pneus', 'M√£o de obra', 'Deprecia√ß√£o e Seguro', 'Outros'],
                    datasets: [{
                        data: costData,
                        backgroundColor: [
                            '#011334',
                            '#E1FF00',
                            '#6b7280',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                padding: 15,
                                font: {
                                    size: 11,
                                    family: 'Poppins'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#011334',
                            titleColor: '#E1FF00',
                            bodyColor: '#fff',
                            borderColor: '#E1FF00',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            // Scenario Comparison Chart - PEERS Style
            const scenarioCtx = document.getElementById('scenarioComparisonChart').getContext('2d');
            charts.scenarioComparison = new Chart(scenarioCtx, {
                type: 'bar',
                data: {
                    labels: ['Pr√©-Reforma', 'P√≥s-Reforma'],
                    datasets: [{
                        label: 'Lucro Operacional',
                        data: [simulationData.lucroOperacionalPre, simulationData.lucroOperacionalPos],
                        backgroundColor: ['#6b7280', '#E1FF00'],
                        borderColor: ['#374151', '#cbd500'],
                        borderWidth: 2,
                        borderRadius: 8,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { 
                                color: '#fff',
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            },
                            grid: { 
                                display: false 
                            }
                        },
                        y: {
                            ticks: { 
                                color: '#fff',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: { 
                                color: 'rgba(255,255,255,0.1)',
                                drawBorder: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#011334',
                            titleColor: '#E1FF00',
                            bodyColor: '#fff',
                            borderColor: '#E1FF00',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
            
            // Creditable Inputs Chart - PEERS Style
            const creditableCtx = document.getElementById('creditableInputsChart').getContext('2d');
            charts.creditableInputs = new Chart(creditableCtx, {
                type: 'bar',
                data: {
                    labels: ['Diesel', 'Ped√°gio', 'Manuten√ß√£o', 'Rastreamento'],
                    datasets: [{
                        label: 'Valores dos Insumos Credit√°veis',
                        data: [
                            simulationData.valorDiesel,
                            simulationData.valorPedagio,
                            simulationData.valorManutencao,
                            simulationData.valorRastreamento
                        ],
                        backgroundColor: '#E1FF00',
                        borderColor: '#cbd500',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            ticks: { 
                                color: '#fff',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: { 
                                color: 'rgba(255,255,255,0.1)',
                                drawBorder: false
                            }
                        },
                        y: {
                            ticks: { 
                                color: '#fff',
                                font: {
                                    size: 11
                                }
                            },
                            grid: { 
                                display: false 
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#011334',
                            titleColor: '#E1FF00',
                            bodyColor: '#fff',
                            borderColor: '#E1FF00',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.x);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTomadorCharts() {
            // Scenario Comparison Chart for Tomador - PEERS Style
            const scenarioCtx = document.getElementById('scenarioComparisonChart').getContext('2d');
            charts.scenarioComparison = new Chart(scenarioCtx, {
                type: 'bar',
                data: {
                    labels: ['Custo Original', 'Cr√©ditos', 'Custo Efetivo'],
                    datasets: [{
                        label: 'Pr√©-Reforma',
                        data: [
                            simulationData.custoFrete,
                            -(simulationData.creditoIcmsPre + simulationData.creditoPisCofinsPre),
                            simulationData.custoEfetivoPre
                        ],
                        backgroundColor: '#6b7280',
                        borderColor: '#374151',
                        borderWidth: 2,
                        borderRadius: 6
                    }, {
                        label: 'P√≥s-Reforma',
                        data: [
                            simulationData.custoFrete,
                            -(simulationData.creditoIbsPos + simulationData.creditoCbsPos),
                            simulationData.custoEfetivoPos
                        ],
                        backgroundColor: '#E1FF00',
                        borderColor: '#cbd500',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { 
                                color: '#fff',
                                font: {
                                    size: 11,
                                    weight: '500'
                                }
                            },
                            grid: { 
                                display: false 
                            }
                        },
                        y: {
                            ticks: { 
                                color: '#fff',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return formatCurrency(Math.abs(value));
                                }
                            },
                            grid: { 
                                color: 'rgba(255,255,255,0.1)',
                                drawBorder: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { 
                                color: '#fff',
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                pointStyle: 'rect'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#011334',
                            titleColor: '#E1FF00',
                            bodyColor: '#fff',
                            borderColor: '#E1FF00',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const value = Math.abs(context.parsed.y);
                                    return context.dataset.label + ': ' + formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
            
            // Hide other charts not relevant for Tomador
            document.getElementById('costBreakdownChart').parentElement.parentElement.style.display = 'none';
            document.getElementById('creditableInputsChart').parentElement.parentElement.style.display = 'none';
        }

        // Calculations
        function calcularPrestador() {
            const receitaBrutaStr = document.getElementById('receita-bruta').value;
            const custosTotaisStr = document.getElementById('custos-totais').value;
            
            const receitaBruta = parseCurrency(receitaBrutaStr);
            const custosTotais = parseCurrency(custosTotaisStr);
            
            if (!receitaBruta || !custosTotais) {
                alert('Por favor, preencha os valores de Receita e Custos.');
                return;
            }

            // Validate costs = 100%
            const totalPercent = updateTotalCosts();
            if (totalPercent > 100) {
                alert(`A soma dos percentuais n√£o pode ultrapassar 100%. Atualmente: ${totalPercent.toFixed(1)}%`);
                return;
            }

            // Get cost percentages
            const custoDiesel = parseFloat(document.getElementById('custo-diesel').value) / 100;
            const custoPedagio = parseFloat(document.getElementById('custo-pedagio').value) / 100;
            const custoManutencao = parseFloat(document.getElementById('custo-manutencao').value) / 100;
            const custoRastreamento = parseFloat(document.getElementById('custo-rastreamento').value) / 100;
            const custoMaoObra = parseFloat(document.getElementById('custo-mao-obra').value) / 100;
            const custoDepreciacao = parseFloat(document.getElementById('custo-depreciacao').value) / 100;
            const custoOutros = (100 - totalPercent) / 100;
            
            // Calculate absolute values
            const valorDiesel = custosTotais * custoDiesel;
            const valorPedagio = custosTotais * custoPedagio;
            const valorManutencao = custosTotais * custoManutencao;
            const valorRastreamento = custosTotais * custoRastreamento;
            
            const totalInsumosCreditaveis = valorDiesel + valorPedagio + valorManutencao + valorRastreamento;

            // PRE-REFORM
            const icmsPre = receitaBruta * 0.12;
            const pisCofinsPre = custosTotais * 0.0925;
            const receitaLiquidaPre = receitaBruta - icmsPre - pisCofinsPre;
            const creditoIcmsDiesel = valorDiesel * 0.171;
            const creditoPisCofins = totalInsumosCreditaveis * 0.0925;
            const lucroOperacionalPre = receitaLiquidaPre - custosTotais + creditoIcmsDiesel + creditoPisCofins;
            const margemPre = receitaBruta > 0 ? lucroOperacionalPre / receitaBruta : 0;

            // POST-REFORM
            const ibsPos = receitaBruta * 0.177;
            const cbsPos = custosTotais * 0.088;
            const receitaLiquidaPos = receitaBruta - ibsPos - cbsPos;
            const creditoIbsInsumos = totalInsumosCreditaveis * 0.177;
            const creditoCbsInsumos = totalInsumosCreditaveis * 0.088;
            const lucroOperacionalPos = receitaLiquidaPos - custosTotais + creditoIbsInsumos + creditoCbsInsumos;
            const margemPos = receitaBruta > 0 ? lucroOperacionalPos / receitaBruta : 0;
            
            const diferencaLucro = lucroOperacionalPos - lucroOperacionalPre;
            const diferencaPercentual = ((lucroOperacionalPos / lucroOperacionalPre) - 1) * 100;

            // Calculate breakeven adjustment
            const lucroAlvo = lucroOperacionalPre;
            const aliquotaCombinada = 0.171 + 0.088;
            const receitaNecessaria = (custosTotais - creditoIbsInsumos - creditoCbsInsumos + lucroAlvo) / (1 - aliquotaCombinada);
            const reajusteNecessario = (receitaNecessaria / receitaBruta) - 1;
            
            // Store data for charts
            simulationData = {
                receitaBruta,
                custosTotais,
                custoDiesel,
                custoPedagio,
                custoManutencao,
                custoRastreamento,
                custoMaoObra,
                custoDepreciacao,
                custoOutros,
                valorDiesel,
                valorPedagio,
                valorManutencao,
                valorRastreamento,
                totalInsumosCreditaveis,
                lucroOperacionalPre,
                lucroOperacionalPos,
                margemPre,
                margemPos,
                diferencaLucro,
                reajusteNecessario,
                icmsPre,
                pisCofinsPre,
                receitaLiquidaPre,
                creditoIcmsDiesel,
                creditoPisCofins,
                ibsPos,
                cbsPos,
                receitaLiquidaPos,
                creditoIbsInsumos,
                creditoCbsInsumos
            };

            // Render Results
            document.getElementById('pre-reforma-content').innerHTML = `
                <div class="cost-item"><span>Receita Bruta:</span><span>${formatCurrency(receitaBruta)}</span></div>
                <div class="cost-item"><span>(-) ICMS (12%):</span><span class="text-red-400">${formatCurrency(icmsPre)}</span></div>
                <div class="cost-item"><span>(-) PIS/COFINS (9,25%):</span><span class="text-red-400">${formatCurrency(pisCofinsPre)}</span></div>
                <div class="cost-item"><span>= Receita L√≠quida:</span><span>${formatCurrency(receitaLiquidaPre)}</span></div>
                <div class="cost-item"><span>(-) Custos Operacionais:</span><span class="text-red-400">${formatCurrency(custosTotais)}</span></div>
                <div class="cost-item"><span>(+) Cr√©dito ICMS Diesel:</span><span class="text-green-400">${formatCurrency(creditoIcmsDiesel)}</span></div>
                <div class="cost-item"><span>(+) Cr√©dito PIS/COFINS:</span><span class="text-green-400">${formatCurrency(creditoPisCofins)}</span></div>
                <div class="cost-item total"><span>= Lucro Operacional:</span><span class="text-xl">${formatCurrency(lucroOperacionalPre)}</span></div>
                <div class="cost-item"><span>Margem Operacional:</span><span>${formatPercentage(margemPre)}</span></div>
            `;

            document.getElementById('pos-reforma-content').innerHTML = `
                <div class="cost-item"><span>Receita Bruta:</span><span>${formatCurrency(receitaBruta)}</span></div>
                <div class="cost-item"><span>(-) IBS (17,7%):</span><span class="text-red-400">${formatCurrency(ibsPos)}</span></div>
                <div class="cost-item"><span>(-) CBS (8,8%):</span><span class="text-red-400">${formatCurrency(cbsPos)}</span></div>
                <div class="cost-item"><span>= Receita L√≠quida:</span><span>${formatCurrency(receitaLiquidaPos)}</span></div>
                <div class="cost-item"><span>(-) Custos Operacionais:</span><span class="text-red-400">${formatCurrency(custosTotais)}</span></div>
                <div class="cost-item"><span>(+) Cr√©dito IBS Insumos:</span><span class="text-green-400">${formatCurrency(creditoIbsInsumos)}</span></div>
                <div class="cost-item"><span>(+) Cr√©dito CBS Insumos:</span><span class="text-green-400">${formatCurrency(creditoCbsInsumos)}</span></div>
                <div class="cost-item total"><span>= Lucro Operacional:</span><span class="text-xl">${formatCurrency(lucroOperacionalPos)}</span></div>
                <div class="cost-item"><span>Margem Operacional:</span><span>${formatPercentage(margemPos)}</span></div>
            `;

            const impactoClass = diferencaLucro >= 0 ? 'positive' : 'negative';
            const impactoIcon = diferencaLucro >= 0 ? 'üìà' : 'üìâ';
            
            document.getElementById('impacto-final').innerHTML = `
                <div class="${impactoClass}">
                    ${impactoIcon} Sua margem operacional ${diferencaLucro >= 0 ? 'aumentar√°' : 'reduzir√°'} em ${formatCurrency(Math.abs(diferencaLucro))}
                </div>
                <div class="text-base mt-3 font-normal" style="color: var(--peers-white);">
                    Isso representa uma varia√ß√£o de ${diferencaPercentual > 0 ? '+' : ''}${diferencaPercentual.toFixed(1)}% no lucro operacional
                </div>
                ${diferencaLucro < 0 ? `
                <div class="text-base mt-4 font-normal" style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
                    üí° Ser√° necess√°rio um reajuste no frete de ${formatPercentage(reajusteNecessario)} para manuten√ß√£o do Lucro Operacional
                </div>
                ` : ''}
            `;
            
            document.getElementById('observacoes').innerHTML = `
                * Regime tribut√°rio de Lucro Real da transportadora<br>
                * Cr√©ditos calculados sobre ${formatPercentage(totalInsumosCreditaveis/custosTotais)} dos custos totais
            `;
            
            document.getElementById('resumo-executivo').innerHTML = `
                <div>‚Ä¢ <strong>Carga tribut√°ria atual:</strong> ${formatPercentage((icmsPre + pisCofinsPre) / receitaBruta)} da receita bruta</div>
                <div>‚Ä¢ <strong>Carga tribut√°ria futura:</strong> ${formatPercentage((ibsPos + cbsPos) / receitaBruta)} da receita bruta</div>
                <div>‚Ä¢ <strong>Cr√©ditos recuper√°veis aumentam:</strong> de ${formatCurrency(creditoIcmsDiesel + creditoPisCofins)} para ${formatCurrency(creditoIbsInsumos + creditoCbsInsumos)}</div>
                <div>‚Ä¢ <strong>Recomenda√ß√£o:</strong> ${diferencaLucro < 0 ? 'Revisar estrutura de custos e negociar reajustes contratuais' : 'Aproveitar a melhoria de margem para investir em competitividade'}</div>
            `;
            
            document.getElementById('resultados').classList.remove('hidden');
            document.getElementById('resultados').classList.add('fade-in');
            updateProgress(3);
            
            // Create charts
            createCharts();
            
            // Scroll to results
            document.getElementById('resultados').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function calcularTomador() {
            const custoFreteStr = document.getElementById('custo-frete').value;
            const custoFrete = parseCurrency(custoFreteStr);
            
            if (!custoFrete) {
                document.getElementById('custo-frete').classList.add('input-error');
                return;
            }

            // PRE-REFORM
            const creditoIcmsPre = custoFrete * 0.024;
            const creditoPisCofinsPre = custoFrete * 0.0925;
            const custoEfetivoPre = custoFrete - creditoIcmsPre - creditoPisCofinsPre;

            // POST-REFORM
            const creditoIbsPos = custoFrete * 0.177;
            const creditoCbsPos = custoFrete * 0.088;
            const custoEfetivoPos = custoFrete - creditoIbsPos - creditoCbsPos;

            const diferencaCusto = custoEfetivoPos - custoEfetivoPre;
            const economiaPercentual = (1 - (custoEfetivoPos / custoEfetivoPre)) * 100;
            
            // With 6.2% adjustment
            const custoFreteReajustado = custoFrete * 1.062;
            const creditoIbsReajustado = custoFreteReajustado * 0.177;
            const creditoCbsReajustado = custoFreteReajustado * 0.088;
            const custoEfetivoReajustado = custoFreteReajustado - creditoIbsReajustado - creditoCbsReajustado;
            
            // Store data for charts
            simulationData = {
                custoFrete,
                creditoIcmsPre,
                creditoPisCofinsPre,
                custoEfetivoPre,
                creditoIbsPos,
                creditoCbsPos,
                custoEfetivoPos,
                diferencaCusto,
                economiaPercentual,
                custoFreteReajustado,
                custoEfetivoReajustado
            };

            // Render Results
            document.getElementById('pre-reforma-content').innerHTML = `
                <div class="cost-item"><span>Custo contratado:</span><span>${formatCurrency(custoFrete)}</span></div>
                <div class="cost-item"><span>(-) Cr√©dito ICMS (2,4%):</span><span class="text-green-400">${formatCurrency(creditoIcmsPre)}</span></div>
                <div class="cost-item"><span>(-) Cr√©dito PIS/COFINS (9,25%):</span><span class="text-green-400">${formatCurrency(creditoPisCofinsPre)}</span></div>
                <div class="cost-item total"><span>= Custo Efetivo:</span><span class="text-xl">${formatCurrency(custoEfetivoPre)}</span></div>
                <div class="cost-item"><span>Cr√©ditos recuperados:</span><span>${formatPercentage((creditoIcmsPre + creditoPisCofinsPre) / custoFrete)}</span></div>
            `;

            document.getElementById('pos-reforma-content').innerHTML = `
                <div class="cost-item"><span>Custo contratado:</span><span>${formatCurrency(custoFrete)}</span></div>
                <div class="cost-item"><span>(-) Cr√©dito IBS (17,7%):</span><span class="text-green-400">${formatCurrency(creditoIbsPos)}</span></div>
                <div class="cost-item"><span>(-) Cr√©dito CBS (8,8%):</span><span class="text-green-400">${formatCurrency(creditoCbsPos)}</span></div>
                <div class="cost-item total"><span>= Custo Efetivo:</span><span class="text-xl">${formatCurrency(custoEfetivoPos)}</span></div>
                <div class="cost-item"><span>Cr√©ditos recuperados:</span><span>${formatPercentage((creditoIbsPos + creditoCbsPos) / custoFrete)}</span></div>
            `;

            const impactoClass = diferencaCusto < 0 ? 'positive' : 'negative';
            const impactoIcon = diferencaCusto < 0 ? 'üí∞' : 'üí∏';
            
            document.getElementById('impacto-final').innerHTML = `
                <div class="${impactoClass}">
                    ${impactoIcon} Seu custo com frete e cr√©ditos ${diferencaCusto < 0 ? 'reduzir√°' : 'aumentar√°'} em ${formatCurrency(Math.abs(diferencaCusto))} considerando os cr√©ditos pass√≠veis de recupera√ß√£o.
                </div>
                <div class="text-base mt-3 font-normal" style="color: var(--peers-white);">
                    Isso representa uma economia de ${economiaPercentual.toFixed(1)}% no custo l√≠quido com fretes
                </div>
                <div class="text-base mt-4 font-normal" style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
                    ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Por√©m estima-se que o transportador deve propor um reajuste em sua tabela na ordem de 6,2%.
                </div>
            `;
            
            document.getElementById('observacoes').innerHTML = `
                * Consideramos 20% como m√©dia de mercado. Ajuste conforme sua realidade.<br>
                * Regime tribut√°rio de Lucro Real
            `;
            
            document.getElementById('resumo-executivo').innerHTML = `
                <div>‚Ä¢ <strong>Economia inicial:</strong> ${formatCurrency(Math.abs(diferencaCusto))} por ano (${economiaPercentual.toFixed(1)}%)</div>
                <div>‚Ä¢ <strong>Cr√©ditos atuais:</strong> ${formatCurrency(creditoIcmsPre + creditoPisCofinsPre)} (${formatPercentage((creditoIcmsPre + creditoPisCofinsPre) / custoFrete)})</div>
                <div>‚Ä¢ <strong>Cr√©ditos futuros:</strong> ${formatCurrency(creditoIbsPos + creditoCbsPos)} (${formatPercentage((creditoIbsPos + creditoCbsPos) / custoFrete)})</div>
                <div>‚Ä¢ <strong>Cen√°rio com reajuste de 6,2%:</strong> Custo efetivo seria ${formatCurrency(custoEfetivoReajustado)} (${custoEfetivoReajustado > custoEfetivoPre ? 'aumento' : 'redu√ß√£o'} de ${formatCurrency(Math.abs(custoEfetivoReajustado - custoEfetivoPre))})</div>
                <div>‚Ä¢ <strong>Recomenda√ß√£o:</strong> Negociar contratos de longo prazo antes da reforma e preparar-se para renegocia√ß√µes</div>
            `;
            
            document.getElementById('resultados').classList.remove('hidden');
            document.getElementById('resultados').classList.add('fade-in');
            updateProgress(3);
            
            // Create charts
            createCharts();
            
            // Scroll to results
            document.getElementById('resultados').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // PDF Generation with improved design
        async function generatePDF() {
            // Check if we have lead data
            if (!leadData.nome) {
                showLeadForm();
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Set default font
            pdf.setFont('helvetica');
            
            // Colors
            const peersBlue = [1, 19, 52];
            const peersLime = [225, 255, 0];
            const white = [255, 255, 255];
            const gray = [107, 114, 128];
            
            // Add dark blue header background
            pdf.setFillColor(...peersBlue);
            pdf.rect(0, 0, 210, 50, 'F');
            
            // Add PEERS logo area with lime background
            pdf.setFillColor(...peersLime);
            pdf.rect(20, 15, 50, 20, 'F');
            
            // Add PEERS text
            pdf.setTextColor(...peersBlue);
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.text('PEERS', 35, 28, { align: 'center' });
            
            // Add tagline
            pdf.setTextColor(...white);
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.text('Consulting + Technology', 130, 25);
            
            // Add date
            pdf.setFontSize(9);
            pdf.text(new Date().toLocaleDateString('pt-BR'), 130, 32);
            
            // Title section
            pdf.setTextColor(...peersBlue);
            pdf.setFontSize(22);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Relat√≥rio de Simula√ß√£o', 105, 70, { align: 'center' });
            pdf.setFontSize(18);
            pdf.text('Reforma Tribut√°ria', 105, 80, { align: 'center' });
            
            // Company info box
            pdf.setDrawColor(...peersLime);
            pdf.setLineWidth(2);
            pdf.rect(20, 95, 170, 40);
            
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(...peersBlue);
            pdf.text(`Empresa: ${leadData.empresa}`, 30, 105);
            pdf.text(`Respons√°vel: ${leadData.nome}`, 30, 112);
            if (leadData.cargo) {
                pdf.text(`Cargo: ${leadData.cargo}`, 30, 119);
            }
            pdf.text(`E-mail: ${leadData.email}`, 30, 126);
            pdf.text(`Perfil: ${selectedProfile === 'tomador' ? 'Contratante' : 'Transportadora'}`, 130, 105);
            pdf.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 130, 112);
            
            // Executive Summary
            let yPosition = 150;
            
            pdf.setFillColor(...peersBlue);
            pdf.rect(20, yPosition - 10, 170, 10, 'F');
            pdf.setTextColor(...white);
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Resumo Executivo', 105, yPosition - 3, { align: 'center' });
            
            yPosition += 10;
            pdf.setTextColor(...peersBlue);
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'normal');
            
            if (selectedProfile === 'prestador') {
                const data = simulationData;
                
                // Key metrics box
                pdf.setFillColor(242, 242, 242);
                pdf.rect(20, yPosition, 170, 50, 'F');
                
                pdf.text(`Receita Bruta Anual: ${formatCurrency(data.receitaBruta)}`, 30, yPosition + 10);
                pdf.text(`Custos Totais: ${formatCurrency(data.custosTotais)}`, 120, yPosition + 10);
                
                pdf.text(`Lucro Operacional Atual: ${formatCurrency(data.lucroOperacionalPre)}`, 30, yPosition + 20);
                pdf.text(`Lucro Operacional Futuro: ${formatCurrency(data.lucroOperacionalPos)}`, 120, yPosition + 20);
                
                pdf.setFont('helvetica', 'bold');
                const impacto = data.diferencaLucro >= 0 ? 'Aumento' : 'Redu√ß√£o';
                const impactColor = data.diferencaLucro >= 0 ? [16, 185, 129] : [239, 68, 68];
                pdf.setTextColor(...impactColor);
                pdf.text(`${impacto} de: ${formatCurrency(Math.abs(data.diferencaLucro))}`, 30, yPosition + 35);
                
                if (data.diferencaLucro < 0) {
                    pdf.setTextColor(...peersBlue);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Reajuste necess√°rio: ${formatPercentage(data.reajusteNecessario)}`, 120, yPosition + 35);
                }
                
                yPosition += 60;
            } else {
                const data = simulationData;
                
                // Key metrics box
                pdf.setFillColor(242, 242, 242);
                pdf.rect(20, yPosition, 170, 40, 'F');
                
                pdf.text(`Custo Total com Frete: ${formatCurrency(data.custoFrete)}`, 30, yPosition + 10);
                pdf.text(`Custo Efetivo Atual: ${formatCurrency(data.custoEfetivoPre)}`, 30, yPosition + 20);
                pdf.text(`Custo Efetivo Futuro: ${formatCurrency(data.custoEfetivoPos)}`, 120, yPosition + 20);
                
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(16, 185, 129);
                pdf.text(`Economia: ${formatCurrency(Math.abs(data.diferencaCusto))}`, 30, yPosition + 35);
                
                pdf.setTextColor(239, 68, 68);
                pdf.setFont('helvetica', 'normal');
                pdf.text('Aten√ß√£o: Transportador pode propor reajuste de 6,2%', 120, yPosition + 30);
                
                yPosition += 50;
            }
            
            // Add new page for charts
            pdf.addPage();
            
            // Charts header
            pdf.setFillColor(...peersBlue);
            pdf.rect(0, 0, 210, 30, 'F');
            pdf.setTextColor(...white);
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.text('An√°lise Gr√°fica', 105, 20, { align: 'center' });
            
            yPosition = 45;
            
            // Convert charts to images and add to PDF
            if (charts.costBreakdown) {
                pdf.setTextColor(...peersBlue);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Composi√ß√£o dos Custos Operacionais', 105, yPosition, { align: 'center' });
                
                const costCanvas = document.getElementById('costBreakdownChart');
                const costImg = await html2canvas(costCanvas, { backgroundColor: null });
                const costImgData = costImg.toDataURL('image/png');
                pdf.addImage(costImgData, 'PNG', 45, yPosition + 5, 120, 80);
                
                yPosition += 95;
            }
            
            if (charts.scenarioComparison) {
                pdf.setTextColor(...peersBlue);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Comparativo de Cen√°rios', 105, yPosition, { align: 'center' });
                
                const scenarioCanvas = document.getElementById('scenarioComparisonChart');
                const scenarioImg = await html2canvas(scenarioCanvas, { backgroundColor: null });
                const scenarioImgData = scenarioImg.toDataURL('image/png');
                pdf.addImage(scenarioImgData, 'PNG', 30, yPosition + 5, 150, 80);
                
                yPosition += 95;
            }
            
            if (selectedProfile === 'prestador' && charts.creditableInputs) {
                // Check if we need a new page
                if (yPosition > 200) {
                    pdf.addPage();
                    yPosition = 30;
                }
                
                pdf.setTextColor(...peersBlue);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Insumos Credit√°veis', 105, yPosition, { align: 'center' });
                
                const creditCanvas = document.getElementById('creditableInputsChart');
                const creditImg = await html2canvas(creditCanvas, { backgroundColor: null });
                const creditImgData = creditImg.toDataURL('image/png');
                pdf.addImage(creditImgData, 'PNG', 30, yPosition + 5, 150, 60);
            }
            
            // Add footer to all pages
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                
                // Footer background
                pdf.setFillColor(...peersBlue);
                pdf.rect(0, 280, 210, 17, 'F');
                
                // Footer text
                pdf.setFontSize(8);
                pdf.setTextColor(...white);
                pdf.text('Simula√ß√£o baseada em EC 132/2023 e PLP 68/2024', 105, 287, { align: 'center' });
                pdf.text(`P√°gina ${i} de ${pageCount}`, 105, 292, { align: 'center' });
                
                // PEERS logo in footer
                pdf.setFillColor(...peersLime);
                pdf.rect(185, 283, 20, 10, 'F');
                pdf.setTextColor(...peersBlue);
                pdf.setFontSize(8);
                pdf.setFont('helvetica', 'bold');
                pdf.text('PEERS', 195, 289, { align: 'center' });
            }
            
            // Save the PDF
            pdf.save(`Simulacao_Reforma_Tributaria_${leadData.empresa.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            
            // Show success message
            alert('PDF gerado com sucesso! O download deve iniciar automaticamente.');
        }

        // Auto-save form data
        function autoSaveFormData() {
            const formData = {
                receitaBruta: document.getElementById('receita-bruta')?.value,
                custosTotais: document.getElementById('custos-totais')?.value,
                custoFrete: document.getElementById('custo-frete')?.value,
                custos: {
                    diesel: document.getElementById('custo-diesel')?.value,
                    pedagio: document.getElementById('custo-pedagio')?.value,
                    manutencao: document.getElementById('custo-manutencao')?.value,
                    rastreamento: document.getElementById('custo-rastreamento')?.value,
                    maoObra: document.getElementById('custo-mao-obra')?.value,
                    depreciacao: document.getElementById('custo-depreciacao')?.value
                }
            };
            sessionStorage.setItem('simuladorFormData', JSON.stringify(formData));
        }

        // Restore form data
        function restoreFormData() {
            const savedData = sessionStorage.getItem('simuladorFormData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                if (formData.receitaBruta) document.getElementById('receita-bruta').value = formData.receitaBruta;
                if (formData.custosTotais) document.getElementById('custos-totais').value = formData.custosTotais;
                if (formData.custoFrete) document.getElementById('custo-frete').value = formData.custoFrete;
                
                if (formData.custos) {
                    Object.keys(formData.custos).forEach(key => {
                        const input = document.getElementById(`custo-${key}`);
                        const range = document.getElementById(`custo-${key}-range`);
                        if (input && formData.custos[key]) {
                            input.value = formData.custos[key];
                            if (range) range.value = formData.custos[key];
                        }
                    });
                    updateTotalCosts();
                }
            }
        }

        // Call restore on page load
        window.addEventListener('load', restoreFormData);

        // Save data on input
        document.addEventListener('input', function(e) {
            if (e.target.matches('input')) {
                autoSaveFormData();
            }
        });
    </script>
</body>
</html>